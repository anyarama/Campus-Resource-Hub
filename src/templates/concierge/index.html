{% extends "base.html" %}

{% block title %}AI Resource Concierge - Campus Resource Hub{% endblock %}

{% block extra_css %}
<style>
    .concierge-hero {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 3rem 0;
        margin: -2rem -15px 2rem;
        text-align: center;
    }
    
    .concierge-hero h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .concierge-hero .subtitle {
        font-size: 1.1rem;
        opacity: 0.95;
    }
    
    .search-container {
        max-width: 800px;
        margin: 0 auto 3rem;
    }
    
    .search-box {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    .query-input {
        width: 100%;
        padding: 1rem;
        font-size: 1.1rem;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        transition: all 0.3s;
    }
    
    .query-input:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        outline: none;
    }
    
    .search-btn {
        width: 100%;
        padding: 1rem;
        font-size: 1.1rem;
        font-weight: 600;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 8px;
        color: white;
        cursor: pointer;
        transition: transform 0.2s;
    }
    
    .search-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }
    
    .search-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    .example-queries {
        margin-top: 1rem;
    }
    
    .example-chip {
        display: inline-block;
        padding: 0.5rem 1rem;
        margin: 0.25rem;
        background: #f5f5f5;
        border: 1px solid #e0e0e0;
        border-radius: 20px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .example-chip:hover {
        background: #667eea;
        color: white;
        border-color: #667eea;
        transform: translateY(-2px);
    }
    
    .results-container {
        max-width: 1000px;
        margin: 0 auto;
        display: none;
    }
    
    .results-container.show {
        display: block;
    }
    
    .ai-message {
        background: #f8f9fa;
        border-left: 4px solid #667eea;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 2rem;
        white-space: pre-line;
    }
    
    .ai-message strong {
        color: #667eea;
    }
    
    .resource-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-top: 2rem;
    }
    
    .resource-result-card {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 1.5rem;
        transition: all 0.3s;
    }
    
    .resource-result-card:hover {
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        transform: translateY(-3px);
    }
    
    .resource-result-card h4 {
        margin-bottom: 0.5rem;
        color: #333;
    }
    
    .resource-meta {
        display: flex;
        gap: 1rem;
        margin: 0.75rem 0;
        font-size: 0.9rem;
        color: #666;
    }
    
    .resource-meta i {
        margin-right: 0.25rem;
    }
    
    .loading-spinner {
        display: none;
        text-align: center;
        margin: 2rem 0;
    }
    
    .loading-spinner.show {
        display: block;
    }
    
    .spinner {
        display: inline-block;
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .no-results {
        text-align: center;
        padding: 3rem;
        color: #666;
    }
    
    .no-results i {
        font-size: 4rem;
        color: #ddd;
        margin-bottom: 1rem;
    }
    
    .features {
        max-width: 1000px;
        margin: 4rem auto;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 2rem;
    }
    
    .feature-card {
        text-align: center;
        padding: 2rem;
    }
    
    .feature-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
    }
    
    .feature-card h3 {
        font-size: 1.2rem;
        margin-bottom: 0.5rem;
    }
    
    .feature-card p {
        color: #666;
        font-size: 0.95rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="concierge-hero">
    <div class="container">
        <h1>ðŸ¤– AI Resource Concierge</h1>
        <p class="subtitle">Just tell me what you need - I'll find it for you!</p>
    </div>
</div>

<div class="container">
    <!-- Search Interface -->
    <div class="search-container">
        <div class="search-box">
            <form id="concierge-form">
                <div class="mb-3">
                    <label for="query-input" class="form-label">What are you looking for?</label>
                    <input 
                        type="text" 
                        id="query-input" 
                        name="query"
                        class="query-input" 
                        placeholder="Try: 'Find a study room for 4 people tomorrow'"
                        maxlength="500"
                        autocomplete="off"
                        required
                    >
                    <small class="text-muted">Ask in plain English - I understand natural language!</small>
                </div>
                
                <button type="submit" class="search-btn" id="search-btn">
                    <i class="bi bi-search"></i> Search
                </button>
            </form>
            
            <!-- Example Queries -->
            <div class="example-queries">
                <small class="text-muted mb-2 d-block">Try these examples:</small>
                {% for example in examples %}
                <span class="example-chip" data-query="{{ example }}">{{ example }}</span>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loading">
        <div class="spinner"></div>
        <p class="mt-2 text-muted">Thinking...</p>
    </div>
    
    <!-- Results Container -->
    <div class="results-container" id="results-container">
        <!-- AI Response Message -->
        <div class="ai-message" id="ai-message"></div>
        
        <!-- Resource Grid -->
        <div class="resource-grid" id="resource-grid"></div>
        
        <!-- No Results -->
        <div class="no-results" id="no-results" style="display: none;">
            <i class="bi bi-inbox"></i>
            <h4>No results found</h4>
            <p>Try adjusting your search or browse all resources.</p>
            <a href="{{ url_for('resources.index') }}" class="btn btn-outline-primary mt-3">
                Browse All Resources
            </a>
        </div>
    </div>
    
    <!-- Features Section (shown when no search yet) -->
    <div class="features" id="features-section">
        <div class="feature-card">
            <div class="feature-icon">ðŸ’¬</div>
            <h3>Natural Language</h3>
            <p>Just ask in plain English - no complex filters needed</p>
        </div>
        
        <div class="feature-card">
            <div class="feature-icon">ðŸŽ¯</div>
            <h3>Smart Matching</h3>
            <p>I understand capacity, dates, times, and locations</p>
        </div>
        
        <div class="feature-card">
            <div class="feature-icon">âš¡</div>
            <h3>Instant Results</h3>
            <p>Get relevant resources in seconds</p>
        </div>
        
        <div class="feature-card">
            <div class="feature-icon">âœ…</div>
            <h3>Database Grounded</h3>
            <p>All results come from real, available resources</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('concierge-form');
    const queryInput = document.getElementById('query-input');
    const searchBtn = document.getElementById('search-btn');
    const loading = document.getElementById('loading');
    const resultsContainer = document.getElementById('results-container');
    const aiMessage = document.getElementById('ai-message');
    const resourceGrid = document.getElementById('resource-grid');
    const noResults = document.getElementById('no-results');
    const featuresSection = document.getElementById('features-section');
    
    // Example chip click handlers
    document.querySelectorAll('.example-chip').forEach(chip => {
        chip.addEventListener('click', function() {
            queryInput.value = this.dataset.query;
            queryInput.focus();
            form.dispatchEvent(new Event('submit'));
        });
    });
    
    // Form submission
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const query = queryInput.value.trim();
        if (!query) return;
        
        // Show loading
        searchBtn.disabled = true;
        loading.classList.add('show');
        resultsContainer.classList.remove('show');
        featuresSection.style.display = 'none';
        
        try {
            // Send query to backend
            const response = await fetch('{{ url_for("concierge.query") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify({ query: query })
            });
            
            const data = await response.json();
            
            // Hide loading
            loading.classList.remove('show');
            searchBtn.disabled = false;
            
            // Show results
            displayResults(data);
            
        } catch (error) {
            console.error('Error:', error);
            loading.classList.remove('show');
            searchBtn.disabled = false;
            alert('An error occurred. Please try again.');
        }
    });
    
    function displayResults(data) {
        resultsContainer.classList.add('show');
        
        // Display AI message
        aiMessage.innerHTML = formatMessage(data.message);
        
        // Display resources
        if (data.results && data.results.length > 0) {
            resourceGrid.innerHTML = '';
            noResults.style.display = 'none';
            
            data.results.forEach(resource => {
                const card = createResourceCard(resource);
                resourceGrid.appendChild(card);
            });
        } else {
            resourceGrid.innerHTML = '';
            noResults.style.display = 'block';
        }
        
        // Scroll to results
        resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    function formatMessage(message) {
        // Convert markdown-style bold to HTML
        return message
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\n\n/g, '<br><br>')
            .replace(/â€¢/g, '<i class="bi bi-check-circle text-success me-2"></i>');
    }
    
    function createResourceCard(resource) {
        const card = document.createElement('div');
        card.className = 'resource-result-card';
        
        card.innerHTML = `
            <h4>${resource.title}</h4>
            <p class="text-muted small">${resource.description || 'No description available'}</p>
            <div class="resource-meta">
                ${resource.capacity ? `<span><i class="bi bi-people"></i> ${resource.capacity}</span>` : ''}
                ${resource.location ? `<span><i class="bi bi-geo-alt"></i> ${resource.location}</span>` : ''}
                ${resource.category ? `<span class="badge bg-primary">${resource.category}</span>` : ''}
            </div>
            <a href="${resource.url}" class="btn btn-primary btn-sm w-100 mt-2">
                View Details <i class="bi bi-arrow-right"></i>
            </a>
        `;
        
        return card;
    }
});
</script>
{% endblock %}
