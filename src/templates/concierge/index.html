{% extends "base.html" %}
{% block title %}AI Resource Concierge Â· Campus Resource Hub{% endblock %}

{% block content %}
<section class="concierge-hero">
  <div class="container">
    <p class="eyebrow">Personalized discovery</p>
    <h1>AI Resource Concierge</h1>
    <p class="text-dim">Describe what you need in plain English and Iâ€™ll translate it into the perfect campus resource.</p>
  </div>
</section>

<section class="concierge-shell container">
  <div class="concierge-search-card card">
    <form id="concierge-form" class="stack-md" novalidate>
      <div>
        <label class="form-label" for="query-input">What are you looking for?</label>
        <input
          id="query-input"
          name="query"
          type="text"
          maxlength="500"
          autocomplete="off"
          class="form-input"
          placeholder="Try: â€œFind a study room for 4 people tomorrow afternoonâ€"
          required
        />
        <small class="text-dim">The concierge understands capacity, categories, locations, dates, and times.</small>
      </div>

      <button id="search-btn" class="btn btn-primary btn--primary" type="submit">
        <i class="bi bi-search icon" aria-hidden="true"></i>
        Search
      </button>
    </form>

    <div class="example-queries" aria-live="polite">
      <span class="text-dim">Try one of these examples:</span>
      <div class="example-chips">
        {% for example in examples %}
          <button type="button" class="chip chip--selectable" data-example="{{ example }}">{{ example }}</button>
        {% endfor %}
      </div>
    </div>
  </div>

  <div id="concierge-error" class="alert alert-warning" role="alert" hidden></div>

  <div id="loading" class="concierge-loading" hidden>
    <div class="spinner-border text-primary" role="status" aria-live="polite" aria-label="Fetching results"></div>
    <p class="text-dim space-t-2">Thinking through the catalogâ€¦</p>
  </div>

  <section id="results-container" class="concierge-results" hidden aria-live="polite">
    <div id="ai-message" class="ai-message"></div>

    <div id="suggestions" class="suggestions" hidden>
      <p class="text-dim">Need another idea?</p>
      <ul id="suggestions-list"></ul>
    </div>

    <div id="resource-grid" class="resource-grid"></div>

    <div id="no-results" class="no-results card" hidden>
      <i class="bi bi-inbox icon" aria-hidden="true"></i>
      <h3>No resources found</h3>
      <p>Try broadening your request or browse everything thatâ€™s currently published.</p>
      <a class="btn btn-outline" href="{{ url_for('resources.index') }}">
        Browse all resources
      </a>
    </div>
  </section>

  <section id="features-section" class="concierge-features">
    <article class="feature-card">
      <div class="feature-icon">ðŸ’¬</div>
      <h3>Natural language</h3>
      <p>Skip the filtersâ€”just describe what you need.</p>
    </article>
    <article class="feature-card">
      <div class="feature-icon">ðŸŽ¯</div>
      <h3>Smart matching</h3>
      <p>Understands capacity, locations, dates, and equipment.</p>
    </article>
    <article class="feature-card">
      <div class="feature-icon">âš¡</div>
      <h3>Instant results</h3>
      <p>Returns only resources that actually exist in the database.</p>
    </article>
    <article class="feature-card">
      <div class="feature-icon">âœ…</div>
      <h3>Grounded answers</h3>
      <p>Every suggestion links directly to the real resource record.</p>
    </article>
  </section>
</section>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('concierge-form');
  const queryInput = document.getElementById('query-input');
  const searchBtn = document.getElementById('search-btn');
  const exampleButtons = document.querySelectorAll('[data-example]');
  const resultsContainer = document.getElementById('results-container');
  const featuresSection = document.getElementById('features-section');
  const aiMessage = document.getElementById('ai-message');
  const resourceGrid = document.getElementById('resource-grid');
  const loading = document.getElementById('loading');
  const errorBanner = document.getElementById('concierge-error');
  const noResults = document.getElementById('no-results');
  const suggestionsWrap = document.getElementById('suggestions');
  const suggestionsList = document.getElementById('suggestions-list');
  const conciergeEndpoint = '{{ url_for("concierge.query") }}';
  const csrfToken = '{{ csrf_token() }}';

  exampleButtons.forEach((btn) => {
    btn.addEventListener('click', () => {
      const example = btn.dataset.example || '';
      queryInput.value = example;
      queryInput.focus();
    });
  });

  form.addEventListener('submit', async (event) => {
    event.preventDefault();
    const query = queryInput.value.trim();

    if (!query) {
      showError('Please enter a search query.');
      return;
    }

    showError(null);
    toggleLoading(true);

    try {
      const response = await fetch(conciergeEndpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken,
        },
        body: JSON.stringify({ query }),
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.message || 'Unable to process your request right now.');
      }

      displayResults(data);
    } catch (error) {
      console.error('Concierge error:', error);
      showError(error.message || 'An unexpected error occurred.');
    } finally {
      toggleLoading(false);
    }
  });

  function toggleLoading(isLoading) {
    searchBtn.disabled = isLoading;
    loading.hidden = !isLoading;
  }

  function showError(message) {
    if (!message) {
      errorBanner.hidden = true;
      errorBanner.textContent = '';
      return;
    }
    errorBanner.hidden = false;
    errorBanner.textContent = message;
  }

  function displayResults(data) {
    resultsContainer.hidden = false;
    featuresSection.hidden = true;
    noResults.hidden = true;
    suggestionsWrap.hidden = true;
    resourceGrid.innerHTML = '';

    aiMessage.innerHTML = formatMessage(data.message || 'Here are the closest matches.');

    if (Array.isArray(data.suggestions) && data.suggestions.length > 0) {
      suggestionsList.innerHTML = '';
      data.suggestions.forEach((suggestion) => {
        const item = document.createElement('li');
        item.textContent = suggestion;
        suggestionsList.appendChild(item);
      });
      suggestionsWrap.hidden = false;
    }

    if (data.results && data.results.length > 0) {
      data.results.forEach((resource) => resourceGrid.appendChild(createResourceCard(resource)));
    } else {
      noResults.hidden = false;
    }

    resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  function formatMessage(message) {
    return message
      .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
      .replace(/\n\n/g, '<br><br>');
  }

  function createResourceCard(resource) {
    const card = document.createElement('div');
    card.className = 'resource-result-card card';

    const description = resource.description || 'No description provided.';
    const trimmedDescription = description.length > 200 ? `${description.slice(0, 197)}â€¦` : description;

    card.innerHTML = `
      <h3>${resource.title}</h3>
      <p class="text-dim small">${trimmedDescription}</p>
      <div class="resource-meta">
        ${resource.capacity ? `<span><i class="bi bi-people" aria-hidden="true"></i> ${resource.capacity}</span>` : ''}
        ${resource.location ? `<span><i class="bi bi-geo-alt" aria-hidden="true"></i> ${resource.location}</span>` : ''}
        ${resource.category ? `<span class="badge badge-primary">${resource.category}</span>` : ''}
      </div>
      <a class="btn btn-outline" href="${resource.url}">
        View details
        <i class="bi bi-arrow-right" aria-hidden="true"></i>
      </a>
    `;

    return card;
  }
});
</script>
{% endblock %}
