{% extends "base.html" %}

{% block title %}Dashboard - Campus Resource Hub{% endblock %}

{% block main_content %}
<section class="resources-dashboard">
  <header class="resources-dashboard__hero">
    <p class="resources-dashboard__eyebrow">Overview</p>
    <h1>Welcome, {{ current_user.name }}!</h1>
    <p>Track bookings, monitor resource health, and spot trends before the semester gets busy.</p>
  </header>

  <div class="resources-dashboard__kpis">
    <article class="ui-card resources-dashboard__kpi">
      <div class="resources-dashboard__kpi-icon resources-dashboard__kpi-icon--primary">
        <i data-lucide="package"></i>
      </div>
      <div>
        <p class="resources-dashboard__kpi-value">{{ dashboard_kpis.my_resources }}</p>
        <p class="resources-dashboard__kpi-label">My resources</p>
      </div>
    </article>

    <article class="ui-card resources-dashboard__kpi">
      <div class="resources-dashboard__kpi-icon resources-dashboard__kpi-icon--success">
        <i data-lucide="calendar-check"></i>
      </div>
      <div>
        <p class="resources-dashboard__kpi-value">{{ dashboard_kpis.active_bookings }}</p>
        <p class="resources-dashboard__kpi-label">Active bookings</p>
      </div>
    </article>

    <article class="ui-card resources-dashboard__kpi">
      <div class="resources-dashboard__kpi-icon resources-dashboard__kpi-icon--info">
        <i data-lucide="message-circle"></i>
      </div>
      <div>
        <p class="resources-dashboard__kpi-value">{{ dashboard_kpis.unread_messages }}</p>
        <p class="resources-dashboard__kpi-label">Unread messages</p>
      </div>
    </article>

    <article class="ui-card resources-dashboard__kpi">
      <div class="resources-dashboard__kpi-icon resources-dashboard__kpi-icon--warning">
        <i data-lucide="star"></i>
      </div>
      <div>
        <p class="resources-dashboard__kpi-value">{{ "%.1f"|format(dashboard_kpis.avg_rating) }}</p>
        <p class="resources-dashboard__kpi-label">Average rating</p>
      </div>
    </article>
  </div>

  <div class="resources-dashboard__charts">
    <article class="ui-card resources-dashboard__chart">
      <div class="resources-dashboard__panel-header">
        <div>
          <p class="resources-dashboard__eyebrow">Bookings</p>
          <h2>Bookings over time</h2>
          <p class="resources-dashboard__muted">Rolling 7-day view</p>
        </div>
      </div>
      {% if dashboard_chart_config.bookings %}
        <div class="resources-dashboard__canvas-wrap">
          <canvas id="chart-bookings" aria-label="Bookings over time" role="img"></canvas>
        </div>
      {% else %}
        <div class="resources-dashboard__empty" role="status">
          <i class="bi bi-activity"></i>
          <p>Not enough booking data yet.</p>
        </div>
      {% endif %}
    </article>

    <article class="ui-card resources-dashboard__chart">
      <div class="resources-dashboard__panel-header">
        <div>
          <p class="resources-dashboard__eyebrow">Inventory</p>
          <h2>Resource mix</h2>
          <p class="resources-dashboard__muted">Breakdown by category</p>
        </div>
      </div>
      {% if dashboard_chart_config.categories %}
        <div class="resources-dashboard__canvas-wrap">
          <canvas id="chart-categories" aria-label="Resource category mix" role="img"></canvas>
        </div>
      {% else %}
        <div class="resources-dashboard__empty" role="status">
          <i class="bi bi-pie-chart"></i>
          <p>Add published listings to unlock category insights.</p>
        </div>
      {% endif %}
    </article>
  </div>

  <div class="resources-dashboard__panels">
    <article class="ui-card resources-dashboard__panel">
      <div class="resources-dashboard__panel-header">
        <div>
          <p class="resources-dashboard__eyebrow">Schedule</p>
          <h2>Upcoming bookings</h2>
          <p class="resources-dashboard__muted">Next confirmed sessions</p>
        </div>
      </div>
      {% if upcoming_bookings %}
        <div class="resources-dashboard__table-wrap">
          <table class="ui-table resources-dashboard__table">
            <thead>
              <tr>
                <th scope="col">Resource</th>
                <th scope="col">Slot</th>
                <th scope="col">Location</th>
                <th scope="col">Status</th>
              </tr>
            </thead>
            <tbody>
              {% for booking in upcoming_bookings %}
              <tr>
                <td>{{ booking.resource }}</td>
                <td>{{ booking.start }} – {{ booking.end }}</td>
                <td>{{ booking.location or '—' }}</td>
                <td>
                  <span class="resources-dashboard__status {{ booking.status_class }}">
                    {{ booking.status_label }}
                  </span>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="resources-dashboard__empty" role="status">
          <i class="bi bi-calendar-x"></i>
          <p>No bookings scheduled. Promote a resource or invite students to reserve a slot.</p>
        </div>
      {% endif %}
    </article>

    <article class="ui-card resources-dashboard__panel">
      <div class="resources-dashboard__panel-header">
        <div>
          <p class="resources-dashboard__eyebrow">Activity</p>
          <h2>Recent updates</h2>
          <p class="resources-dashboard__muted">Latest booking movements</p>
        </div>
      </div>
      {% if recent_activity %}
        <ul class="resources-dashboard__activity">
          {% for item in recent_activity %}
          <li class="resources-dashboard__activity-item">
            <div class="resources-dashboard__activity-icon">
              <i class="bi bi-{{ item.icon }}" aria-hidden="true"></i>
            </div>
            <div>
              <p class="resources-dashboard__activity-title">{{ item.title }}</p>
              <p class="resources-dashboard__muted">{{ item.status }} · {{ item.timestamp }}</p>
            </div>
          </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="resources-dashboard__empty" role="status">
          <i class="bi bi-activity"></i>
          <p>No booking activity yet. Approvals, cancellations, and reviews will appear here.</p>
        </div>
      {% endif %}
    </article>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
  (function(config) {
    if (!config) return;
    function boot() {
      if (window.initDashboardCharts) {
        window.initDashboardCharts(config);
      }
    }
    if (window.initDashboardCharts) {
      boot();
    } else {
      window.addEventListener('dashboard-charts-ready', boot, { once: true });
    }
  })({{ dashboard_chart_config|tojson }});
</script>
{% endblock %}
