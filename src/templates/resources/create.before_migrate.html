{% extends "base.html" %}


{% block title %}Create New Resource - Campus Resource Hub{% endblock %}

{% block content %}
  <!-- Header -->
  <div class="layout-grid">
    <div class="col-lg-8 mx-auto">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="{{ url_for('resources.index') }}">Resources</a></li>
          <li class="breadcrumb-item"><a href="{{ url_for('resources.my_resources') }}">My Resources</a></li>
          <li class="breadcrumb-item active" aria-current="page">Create New</li>
        </ol>
      </nav>
      <h1 class="display-5"><i class="bi bi-plus-circle icon"></i> Create New Resource</h1>
      <p class="text-muted">Share your campus resource with the community</p>
    </div>
  </div>

  <!-- Form -->
  <div class="layout-grid">
    <div class="col-lg-8 mx-auto">
      <div class="card">
        <div class="card-body">
          <form method="POST" action="{{ url_for('resources.create') }}" enctype="multipart/form-data" id="createResourceForm">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <!-- Title -->
            <div class="mb-4">
              <label for="title" class="form-label fw-bold">
                Resource Title <span class="text-danger">*</span>
              </label>
              <input type="text" 
                  class="form-control form-control-lg" 
                  id="title" 
                  name="title" 
                  placeholder="e.g., Conference Room A, MacBook Pro, 3D Printer"
                  required
                  maxlength="200"
                  autocomplete="off">
              <div class="form-text">Give your resource a clear, descriptive name</div>
            </div>

            <!-- Category -->
            <div class="mb-4">
              <label for="category" class="form-label fw-bold">
                Category <span class="text-danger">*</span>
              </label>
              <select class="form-select form-control" id="category" name="category" required>
                <option value="">-- Select Category --</option>
                <option value="Study Space">Study Space</option>
                <option value="Equipment">Equipment</option>
                <option value="Lab">Lab / Workshop</option>
                <option value="Event Space">Event Space</option>
                <option value="Technology">Technology</option>
                <option value="Tutoring">Tutoring / Mentoring</option>
                <option value="Sports">Sports Facility</option>
                <option value="Other">Other</option>
              </select>
              <div class="form-text">Choose the category that best describes your resource</div>
            </div>

            <!-- Description -->
            <div class="mb-4">
              <label for="description" class="form-label fw-bold">
                Description <span class="text-danger">*</span>
              </label>
              <textarea class="form-control" 
                   id="description" 
                   name="description" 
                   rows="5"
                   placeholder="Describe your resource: features, availability, rules, what makes it special..."
                   required
                   maxlength="2000"></textarea>
              <div class="form-text">
                <span id="charCount">0</span> / 2000 characters
              </div>
            </div>

            <!-- Location and Capacity Row -->
            <div class="layout-grid">
              <div class="layout-col" data-col="12">
                <label for="location" class="form-label fw-bold">
                  Location <span class="text-danger">*</span>
                </label>
                <input type="text" 
                    class="form-control" 
                    id="location" 
                    name="location" 
                    placeholder="e.g., Building A, Room 210"
                    required
                    maxlength="200">
                <div class="form-text">Where is this resource located?</div>
              </div>
              <div class="layout-col" data-col="12">
                <label for="capacity" class="form-label fw-bold">
                  Capacity (Optional)
                </label>
                <input type="number" 
                    class="form-control" 
                    id="capacity" 
                    name="capacity" 
                    placeholder="e.g., 10"
                    min="1"
                    max="999">
                <div class="form-text">How many people can use this?</div>
              </div>
            </div>

            <!-- Image Upload -->
            <div class="mb-4">
              <label for="images" class="form-label fw-bold">
                Images (Optional)
              </label>
              <input type="file"  
                  id="images" 
                  name="images" 
                  accept="image/jpeg,image/jpg,image/png,image/gif"
                  multiple>
              <div class="form-text">
                <i class="bi bi-info-circle icon"></i> Upload up to 5 images (JPEG, PNG, GIF). Max 2MB per image.
              </div>
              
              <!-- Image Preview -->
              <div id="imagePreview" class="mt-3 row g-2"></div>
            </div>

            <!-- Status -->
            <div class="mb-4">
              <label class="form-label fw-bold">Publication Status</label>
              <div class="form-check">
                <input class="form-check-input" 
                    type="radio" 
                    name="status" 
                    id="statusDraft" 
                    value="draft" 
                    checked>
                <label class="form-check-label" for="statusDraft">
                  <strong>Save as Draft</strong>
                  <span class="text-muted small">You can edit and publish later</span>
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" 
                    type="radio" 
                    name="status" 
                    id="statusPublished" 
                    value="published">
                <label class="form-check-label" for="statusPublished">
                  <strong>Publish Immediately</strong>
                  <span class="text-muted small">Make visible to all users right away</span>
                </label>
              </div>
            </div>

            <!-- Action Buttons -->
            <hr class="my-4">
            <div class="d-flex">
              <a href="{{ url_for('resources.my_resources') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left icon"></i> Cancel
              </a>
              <button type="submit" class="btn btn-primary btn--primary">
                <i class="bi bi-check-circle icon"></i> Create Resource
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Help Section -->
      <div class="card">
        <div class="card-body">
          <h6 class="card-title"><i class="bi bi-lightbulb icon"></i> Tips for Creating Great Resources</h6>
          <ul class="mb-0 small">
            <li>Use clear, descriptive titles that help users find your resource</li>
            <li>Include high-quality photos showing the resource from multiple angles</li>
            <li>Mention any requirements (training, prerequisites, booking rules)</li>
            <li>Specify capacity and any equipment included</li>
            <li>Keep your description concise but informative</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* Form styling enhancements */
  .form-label.fw-bold {
    color: var(--brand-600);
  }

  .form-control:focus,
  .form-select:focus {
    border-color: var(--brand-600);
    box-shadow: 0 0 0 0.2rem rgba(74, 144, 226, 0.25);
  }

  .form-check-input:checked {
    background-color: var(--brand-600);
    border-color: var(--brand-600);
  }

  /* Image preview styling */
  #imagePreview .preview-item {
    position: relative;
    border-radius: 0.5rem;
    overflow: hidden;
    border: 2px solid var(--brand-600);
  }

  #imagePreview .preview-item img {
    width: 100%;
    height: 150px;
    object-fit: cover;
  }

  #imagePreview .preview-item .remove-btn {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background: rgba(255, 255, 255, 0.9);
    border: none;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
  }

  #imagePreview .preview-item .remove-btn:hover {
    background: var(--brand-600);
    color: white;
  }

  /* Card enhancements */
  .card.shadow-sm {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.08) !important;
  }

  /* Character counter */
  #charCount {
    font-weight: bold;
    color: var(--brand-600);
  }
</style>

<script>
  // Character counter for description
  const descriptionField = document.getElementById('description');
  const charCount = document.getElementById('charCount');

  descriptionField.addEventListener('input', function() {
    charCount.textContent = this.value.length;
    
    // Change color based on length
    if (this.value.length > 1800) {
      charCount.style.color = 'var(--brand-600)'; // Red
    } else if (this.value.length > 1500) {
      charCount.style.color = 'var(--brand-600)'; // Yellow
    } else {
      charCount.style.color = 'var(--brand-600)'; // Blue
    }
  });

  // Image preview functionality
  const imageInput = document.getElementById('images');
  const imagePreview = document.getElementById('imagePreview');
  let selectedFiles = [];

  imageInput.addEventListener('change', function(e) {
    const files = Array.from(e.target.files);
    
    // Validate number of files
    if (files.length > 5) {
      alert('You can only upload up to 5 images.');
      this.value = '';
      return;
    }

    // Validate file sizes
    for (const file of files) {
      if (file.size > 2 * 1024 * 1024) { // 2MB
        alert(`File"${file.name}" is too large. Maximum size is 2MB.`);
        this.value = '';
        imagePreview.innerHTML = '';
        selectedFiles = [];
        return;
      }
    }

    selectedFiles = files;
    displayPreviews(files);
  });

  function displayPreviews(files) {
    imagePreview.innerHTML = '';
    
    files.forEach((file, index) => {
      const reader = new FileReader();
      
      reader.onload = function(e) {
        const col = document.createElement('div');
        col.className = 'col-md-4';
        
        col.innerHTML = `
          <div class="preview-item">
            <img src="${e.target.result}" alt="Preview ${index + 1}">
            <button type="button" class="remove-btn btn btn--primary" onclick="removeImage(${index})" title="Remove image">
              <i class="bi bi-x icon"></i>
            </button>
          </div>
        `;
        
        imagePreview.appendChild(col);
      };
      
      reader.readAsDataURL(file);
    });
  }

  function removeImage(index) {
    selectedFiles.splice(index, 1);
    
    // Update file input
    const dt = new DataTransfer();
    selectedFiles.forEach(file => dt.items.add(file));
    imageInput.files = dt.files;
    
    displayPreviews(selectedFiles);
  }

  // Form validation
  document.getElementById('createResourceForm').addEventListener('submit', function(e) {
    const title = document.getElementById('title').value.trim();
    const description = document.getElementById('description').value.trim();
    const category = document.getElementById('category').value;
    const location = document.getElementById('location').value.trim();

    if (!title || !description || !category || !location) {
      e.preventDefault();
      alert('Please fill in all required fields.');
      return false;
    }

    if (title.length < 3) {
      e.preventDefault();
      alert('Title must be at least 3 characters long.');
      return false;
    }

    if (description.length < 10) {
      e.preventDefault();
      alert('Description must be at least 10 characters long.');
      return false;
    }

    // Show loading indicator
    const submitBtn = this.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>Creating...';
    
    return true;
  });
</script>
{% endblock %}
