{% extends "base.html" %}

{% block title %}{{ resource.title }} - Campus Resource Hub{% endblock %}

{% set category_label = resource.category|replace('_', ' ')|title %}
{% set hours = availability.get('hours', {}) if availability else {} %}
{% set availability_days = availability.get('days', []) if availability else [] %}
{% set availability_notes = availability.get('notes') if availability else None %}

{% block content %}
<div class="resource-detail">
  <nav aria-label="Breadcrumb" class="resource-detail__breadcrumbs">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{{ url_for('resources.index') }}">Resources</a></li>
      <li class="breadcrumb-item"><a href="{{ url_for('resources.index', category=resource.category) }}">{{ category_label }}</a></li>
      <li class="breadcrumb-item active" aria-current="page">{{ resource.title }}</li>
    </ol>
  </nav>

  <div class="resource-detail__hero layout-grid">
    <div class="layout-col" data-col="12" data-col-lg="8">
      {% if images %}
        <section class="resource-carousel">
          <div class="carousel" data-carousel aria-label="Resource images">
            <div class="carousel__track">
              {% for image in images %}
              <div class="carousel__slide{% if loop.first %} is-active{% endif %}" aria-hidden="{{ 'false' if loop.first else 'true' }}">
                <img 
                  data-src="{{ url_for('static', filename='uploads/' + image) }}" 
                  alt="{{ resource.title }} image {{ loop.index }}" 
                >
              </div>
              {% endfor %}
            </div>
            <div class="carousel__nav carousel__nav--prev">
              <button type="button" data-carousel-prev aria-label="Previous image" class="btn btn--primary">
                <i data-lucide="chevron-left" class="icon icon-sm"></i>
              </button>
            </div>
            <div class="carousel__nav carousel__nav--next">
              <button type="button" data-carousel-next aria-label="Next image" class="btn btn--primary">
                <i data-lucide="chevron-right" class="icon icon-sm"></i>
              </button>
            </div>
            <div class="carousel__controls">
              <span class="carousel__counter" data-carousel-counter>1 / {{ images|length }}</span>
              <button type="button" class="carousel__fullscreen btn btn--primary" data-carousel-fullscreen aria-label="Toggle fullscreen">
                <i data-lucide="maximize-2" class="icon icon-sm"></i>
              </button>
            </div>
          </div>
          {% if images|length > 1 %}
          <div class="carousel__thumbnails">
            {% for image in images %}
            <button type="button" class="carousel__thumb{% if loop.first %} is-active{% endif %} btn btn--primary" aria-label="Go to image {{ loop.index }}">
              <img src="{{ url_for('static', filename='uploads/' + image) }}" alt="Thumbnail {{ loop.index }}">
            </button>
            {% endfor %}
          </div>
          {% endif %}
        </section>
      {% else %}
        <div class="resource-carousel resource-carousel--empty">
          <div class="resource-carousel__placeholder">
            <i data-lucide="image" class="icon icon-sm"></i>
            <p>No images uploaded yet</p>
          </div>
        </div>
      {% endif %}

      <header class="resource-header">
        <div class="resource-header__labels">
          <span class="badge badge--ghost">{{ category_label }}</span>
          {% if resource.status != 'published' %}
            <span class="badge badge--secondary">{{ resource.status|title }}</span>
          {% endif %}
        </div>
        <h1 class="resource-title">{{ resource.title }}</h1>
        <div class="resource-meta">
          {% if average_rating %}
          <div class="resource-meta__item">
            <i data-lucide="star" class="icon-filled icon icon-sm"></i>
            <strong>{{ average_rating }}</strong>
            <span class="text-muted">({{ review_count }} reviews)</span>
          </div>
          {% else %}
          <div class="resource-meta__item text-muted">
            <i data-lucide="star" class="icon icon-sm"></i>
            No reviews yet
          </div>
          {% endif %}
          {% if resource.capacity %}
          <div class="resource-meta__item">
            <i data-lucide="users" class="icon icon-sm"></i>
            {{ resource.capacity }} person{{ 's' if resource.capacity != 1 else '' }} max
          </div>
          {% endif %}
          {% if resource.location %}
          <div class="resource-meta__item">
            <i data-lucide="map-pin" class="icon icon-sm"></i>
            {{ resource.location }}
          </div>
          {% endif %}
        </div>
      </header>

      <div class="resource-quick-facts">
        <div class="quick-fact">
          <span class="quick-fact__label">Capacity</span>
          <span class="quick-fact__value">{{ resource.capacity if resource.capacity else 'Flexible' }}</span>
        </div>
        <div class="quick-fact">
          <span class="quick-fact__label">Building</span>
          <span class="quick-fact__value">
            {% if resource.location %}
              {{ resource.location.split(',')[0] }}
            {% else %}
              Not specified
            {% endif %}
          </span>
        </div>
        <div class="quick-fact">
          <span class="quick-fact__label">Equipment</span>
          <span class="quick-fact__value">
            {% if availability and availability.get('equipment') %}
              {{ availability.get('equipment')|join(', ') }}
            {% elif availability_notes %}
              {{ availability_notes }}
            {% else %}
              Standard AV + Wi-Fi
            {% endif %}
          </span>
        </div>
      </div>
    </div>

    <aside class="layout-col resource-detail__rail" data-col="12" data-col-lg="4">
      <section class="resource-card resource-card--availability">
        <div class="resource-card__header">
          <div>
            <p class="eyebrow">Availability</p>
            <h3>Upcoming 2 weeks</h3>
          </div>
          {% if next_available_date %}
          <span class="badge badge--success">Next open {{ next_available_date.strftime('%b %d') }}</span>
          {% endif %}
        </div>
        <div class="availability-calendar" role="list">
          {% for day in availability_calendar %}
          <div class="availability-day availability-day--{{ day.status }}" role="listitem">
            <span class="availability-day__dow">{{ day.date.strftime('%a') }}</span>
            <span class="availability-day__date">{{ day.date.strftime('%b %d') }}</span>
          </div>
          {% endfor %}
        </div>
        {% if current_user.is_authenticated and resource.status == 'published' %}
        <button
          type="button"
          class="btn btn--primary btn--full"
          data-booking-open
          data-resource-id="{{ resource.resource_id }}"
          data-resource-title="{{ resource.title }}"
          data-booking-url="{{ url_for('bookings.new', resource_id=resource.resource_id) }}"
          data-availability-url="{{ url_for('resources.availability', resource_id=resource.resource_id) }}"
        >
          <i data-lucide="calendar-check" class="icon icon-sm"></i>
          Book this resource
        </button>
        {% else %}
        <a href="{{ url_for('bookings.new', resource_id=resource.resource_id) }}" class="btn btn--primary btn--full">
          <i data-lucide="calendar-check" class="icon icon-sm"></i>
          View booking options
        </a>
        {% endif %}
      </section>

      <section class="resource-card">
        <div class="resource-card__header">
          <p class="eyebrow">Owner</p>
          <h3>Managed by</h3>
        </div>
        <div class="resource-owner">
          <div class="resource-owner__avatar">
            <i data-lucide="shield" class="icon icon-sm"></i>
          </div>
          <div>
            <p class="resource-owner__name">{{ resource.owner.name if resource.owner else 'Campus Staff' }}</p>
            {% if resource.owner and resource.owner.department %}
              <p class="text-muted">{{ resource.owner.department }}</p>
            {% endif %}
          </div>
        </div>
        <ul class="resource-list">
          <li>
            <i data-lucide="mail" class="icon icon-sm"></i>
            <span>{{ resource.owner.email if resource.owner else 'Contact via messaging' }}</span>
          </li>
          <li>
            <i data-lucide="clock-3" class="icon icon-sm"></i>
            <span>Replies within 1 business day</span>
          </li>
        </ul>
      </section>
    </aside>
  </div>

  <div class="resource-detail__body layout-grid">
    <section class="layout-col resource-panel" data-col="12" data-col-lg="8">
      <h2>About this resource</h2>
      <p>
        {% if resource.description %}
          {{ resource.description }}
        {% else %}
          The owner has not added a description yet.
        {% endif %}
      </p>

      <div class="resource-availability">
        <div>
          <p class="eyebrow">Preferred days</p>
          {% if availability_days %}
            <p>{{ availability_days|map('capitalize')|join(', ') }}</p>
          {% else %}
            <p>Owner will coordinate availability after booking.</p>
          {% endif %}
        </div>
        <div>
          <p class="eyebrow">Hours</p>
          {% if hours %}
            <p>{{ hours.get('start', '08:00') }} - {{ hours.get('end', '18:00') }}</p>
          {% else %}
            <p>Standard business hours</p>
          {% endif %}
        </div>
        <div>
          <p class="eyebrow">Approval</p>
          <p>{{ 'Requires owner approval' if availability and availability.get('requires_approval') else 'Auto-approve' }}</p>
        </div>
      </div>
    </section>

    <section class="layout-col resource-panel" data-col="12">
      <div class="resource-reviews__header">
        <div>
          <p class="eyebrow">Reviews</p>
          <h2>{{ review_count }} review{{ 's' if review_count != 1 else '' }}</h2>
        </div>
        {% if can_review %}
          <button type="button" class="btn btn--outline btn--primary" data-drawer-open="reviewSheet">
            <i data-lucide="star" class="icon icon-sm"></i>
            Write a review
          </button>
        {% elif not current_user.is_authenticated %}
          <a href="{{ url_for('auth.login') }}" class="btn btn--outline">
            <i data-lucide="log-in" class="icon icon-sm"></i>
            Sign in to review
          </a>
        {% endif %}
      </div>

      {% if reviews %}
      <div class="resource-reviews">
        {% for review in reviews %}
          <article class="review-card{% if review.is_hidden %} review-card--hidden{% endif %}">
            <div class="review-card__header">
              <div>
                <p class="review-card__name">{{ review.reviewer.name }}</p>
                <p class="review-card__meta">
                  <i data-lucide="clock-3" class="icon icon-sm"></i>
                  {{ review.timestamp.strftime('%b %d, %Y') }}
                </p>
              </div>
              <div class="review-card__badges">
                {% if review.booking_id %}
                  <span class="chip chip--success">
                    <i data-lucide="badge-check" class="icon icon-sm"></i>
                    Verified booking
                  </span>
                {% endif %}
                {% if show_moderation %}
                  <span class="chip chip--info">
                    <i data-lucide="shield" class="icon icon-sm"></i>
                    {{ 'Hidden' if review.is_hidden else 'Visible' }}
                  </span>
                {% endif %}
              </div>
            </div>
            <div class="review-card__rating">
              {% for star in range(1, 6) %}
                <i data-lucide="star" class="{% if star <= review.rating %}icon-filled{% endif %} icon icon-sm"></i>
              {% endfor %}
            </div>
            <p class="review-card__body">
              {{ review.comment or 'Reviewer did not leave additional comments.' }}
            </p>
          </article>
        {% endfor %}
      </div>
      {% else %}
      <div class="empty-state empty-state--inline">
        <div class="empty-state__icon">
          <i data-lucide="chat-bubble-oval-ellipsis" class="icon icon-sm"></i>
        </div>
        <h3>No reviews yet</h3>
        <p>Be the first to share feedback after booking.</p>
      </div>
      {% endif %}
    </section>
  </div>
</div>

{# Review Drawer #}
{% if current_user.is_authenticated and can_review %}
<div id="reviewSheet" class="drawer" role="dialog" aria-modal="true" aria-labelledby="review-sheet-title">
  <div class="drawer-header">
    <h2 id="review-sheet-title">Share your experience</h2>
    <button type="button" class="drawer-close btn btn--primary" data-drawer-close aria-label="Close review drawer">
      <i data-lucide="x" class="icon icon-sm"></i>
    </button>
  </div>
  <div class="drawer-body">
    <form method="POST" action="{{ url_for('reviews.create', resource_id=resource.resource_id) }}" class="form-grid">
      {{ csrf_token() }}
      <div class="form-group">
        <label for="review-rating">Rating</label>
        <select id="review-rating" name="rating" required class="form-control">
          <option value="">Select...</option>
          {% for value in range(5, 0, -1) %}
            <option value="{{ value }}">{{ value }} - {{ ['Poor','Fair','Good','Very good','Excellent'][value-1] }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label for="review-comment">Comments</label>
        <textarea id="review-comment" name="comment" rows="4" placeholder="What should other students know?" required class="form-control"></textarea>
      </div>
      <button type="submit" class="btn btn--primary btn--full">
        Submit review
      </button>
    </form>
  </div>
</div>
{% endif %}

</div>
{% endblock %}

{% block extra_js %}
  <script type="module" src="{{ vite_asset('src/static/js/image-carousel.js') }}"></script>
  <script type="module">
    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }
  </script>
{% endblock %}
