{% set state = form_data or {} %}
{% set selected_days = state.get('availability_days', []) %}
{% if selected_days is string %}
  {% set selected_days = [selected_days] %}
{% endif %}
{% set day_options = [
  ('monday', 'Monday'),
  ('tuesday', 'Tuesday'),
  ('wednesday', 'Wednesday'),
  ('thursday', 'Thursday'),
  ('friday', 'Friday'),
  ('saturday', 'Saturday'),
  ('sunday', 'Sunday')
] %}

<div class="resource-form">
  <header class="resource-form__header">
    <div>
      <p class="eyebrow">{{ 'Edit resource' if is_edit else 'New resource' }}</p>
      <h1>{{ form_heading }}</h1>
      <p class="text-muted">{{ form_subheading }}</p>
    </div>
    {% if is_edit %}
      <a href="{{ url_for('resources.detail', resource_id=resource.resource_id) }}" class="btn btn--ghost">
        <i data-lucide="arrow-left"></i>
        Back to detail
      </a>
    {% endif %}
  </header>

  {% if form_errors and form_errors.get('__all__') %}
    <div class="alert alert--error">
      <i data-lucide="alert-circle"></i>
      <span>{{ form_errors.get('__all__') }}</span>
    </div>
  {% endif %}

  <form 
    method="POST" 
    action="{{ form_action }}" 
    enctype="multipart/form-data" 
    class="resource-form__content" 
    data-tabs
  >
    {{ csrf_token() }}

    <div class="form-stepper" role="tablist">
      <button type="button" class="form-stepper__tab active" data-tab-trigger="step-core" aria-selected="true">
        <span>1</span>
        Core Info
      </button>
      <button type="button" class="form-stepper__tab" data-tab-trigger="step-media" aria-selected="false">
        <span>2</span>
        Images
      </button>
      <button type="button" class="form-stepper__tab" data-tab-trigger="step-availability" aria-selected="false">
        <span>3</span>
        Availability & Rules
      </button>
    </div>

    <section id="step-core" class="form-step active" role="tabpanel">
      <div class="form-grid">
        <div class="form-group">
          <label for="title">Resource title</label>
          <input 
            type="text" 
            id="title" 
            name="title" 
            required 
            maxlength="200"
            placeholder="Conference room, camera kit..."
            value="{{ state.get('title', '') }}"
          >
        </div>
        <div class="form-group">
          <label for="category">Category</label>
          <select id="category" name="category" required>
            <option value="">Select a category</option>
            {% for option in category_filters %}
              <option value="{{ option.value }}" {% if state.get('category') == option.value %}selected{% endif %}>
                {{ option.label }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group form-group--full">
          <label for="description">Description</label>
          <textarea 
            id="description" 
            name="description" 
            rows="6" 
            maxlength="2000" 
            placeholder="Describe key features, included amenities, and usage guidelines."
            required
          >{{ state.get('description', '') }}</textarea>
        </div>
        <div class="form-group">
          <label for="location">Location</label>
          <input 
            type="text" 
            id="location" 
            name="location" 
            required 
            placeholder="Building / Room"
            value="{{ state.get('location', '') }}"
          >
        </div>
        <div class="form-group">
          <label for="capacity">Capacity (optional)</label>
          <input 
            type="number" 
            id="capacity" 
            name="capacity" 
            min="1" 
            max="999"
            value="{{ state.get('capacity', '') }}"
          >
        </div>
      </div>

      <fieldset class="form-fieldset">
        <legend>Visibility</legend>
        {% set status_value = state.get('status', 'draft') %}
        <label class="form-option">
          <input type="radio" name="status" value="draft" {% if status_value == 'draft' %}checked{% endif %}>
          <div>
            <strong>Draft</strong>
            <p class="text-muted">Keep private while you finish details.</p>
          </div>
        </label>
        <label class="form-option">
          <input type="radio" name="status" value="published" {% if status_value == 'published' %}checked{% endif %}>
          <div>
            <strong>Publish</strong>
            <p class="text-muted">Make visible to all students and staff.</p>
          </div>
        </label>
      </fieldset>
    </section>

    <section id="step-media" class="form-step" role="tabpanel" hidden>
      <div class="form-group form-group--full">
        <label for="images">Upload images</label>
        <input type="file" id="images" name="images" accept="image/*" multiple>
        <p class="form-help">JPEG/PNG up to 2MB each. First image becomes the cover.</p>
      </div>
      {% if images %}
      <div class="media-preview-grid">
        {% for image in images %}
        <figure class="media-preview">
          <img src="{{ url_for('static', filename='uploads/' + image) }}" alt="Existing image {{ loop.index }}">
          <figcaption>{{ image }}</figcaption>
        </figure>
        {% endfor %}
      </div>
      {% endif %}
    </section>

    <section id="step-availability" class="form-step" role="tabpanel" hidden>
      <div class="form-group form-group--full">
        <label>Available days</label>
        <div class="chip-group">
          {% for value, label in day_options %}
          <label class="chip chip--selectable">
            <input type="checkbox" name="availability_days" value="{{ value }}" {% if value in selected_days %}checked{% endif %}>
            <span>{{ label }}</span>
          </label>
          {% endfor %}
        </div>
      </div>
      <div class="form-grid">
        <div class="form-group">
          <label for="availability_start">Start time</label>
          <input type="time" id="availability_start" name="availability_start" value="{{ state.get('availability_start', '') }}">
        </div>
        <div class="form-group">
          <label for="availability_end">End time</label>
          <input type="time" id="availability_end" name="availability_end" value="{{ state.get('availability_end', '') }}">
        </div>
      </div>
      <label class="form-option form-option--inline">
        <input type="checkbox" name="requires_approval" {% if state.get('requires_approval') in ['on', True] %}checked{% endif %}>
        <div>
          <strong>Requires approval</strong>
          <p class="text-muted">Owner must approve bookings before confirmation.</p>
        </div>
      </label>
      <div class="form-group form-group--full">
        <label for="availability_notes">Booking notes</label>
        <textarea id="availability_notes" name="availability_notes" rows="4" placeholder="Share setup notes, equipment requirements, or onboarding steps.">{{ state.get('availability_notes', '') }}</textarea>
      </div>
    </section>

    <footer class="resource-form__footer">
      {% if is_edit %}
        <a href="{{ url_for('resources.detail', resource_id=resource.resource_id) }}" class="btn btn--ghost">
          Cancel
        </a>
      {% else %}
        <a href="{{ url_for('resources.index') }}" class="btn btn--ghost">
          Cancel
        </a>
      {% endif %}
      <button type="submit" class="btn btn--primary">{{ submit_label }}</button>
    </footer>
  </form>
</div>
