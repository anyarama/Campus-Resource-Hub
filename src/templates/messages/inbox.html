{% extends "base.html" %}

{% block title %}Messages - Campus Resource Hub{% endblock %}

{% block main_content %}
<section class="messages-workspace" data-messages-page>
  <div class="messages-workspace__sidebar">
    <article class="ui-card messages-sidebar">
      <div class="messages-sidebar__header">
        <p class="resources-dashboard__eyebrow">Inbox</p>
        <h1>Messages</h1>
        <p>Keep conversations with students and owners in one place.</p>
      </div>
      <div class="messages-sidebar__search">
        <i data-lucide="search" class="icon icon-sm"></i>
        <input
          type="search"
          placeholder="Search conversations"
          autocomplete="off"
          data-conversation-search
          class="ui-input">
      </div>
      <div class="messages-sidebar__metrics">
        <span class="messages-sidebar__metric">
          <i data-lucide="mail" class="icon icon-xs"></i>{{ stats.total_received }} received
        </span>
        <span class="messages-sidebar__metric">
          <i data-lucide="send" class="icon icon-xs"></i>{{ stats.total_sent }} sent
        </span>
        <span class="messages-sidebar__metric">
          <i data-lucide="bell" class="icon icon-xs"></i>{{ stats.unread }} unread
        </span>
      </div>
    </article>

    <div class="conversation-list" data-conversation-list>
      {% if conversations %}
        {% for conv in conversations %}
          {% set other = conv.other_user %}
          <a
            href="{{ url_for('messages.inbox', user_id=other.user_id) }}"
            class="conversation-list__item {% if selected_user_id == other.user_id %}is-active{% endif %}"
            data-conversation-link>
            <div class="conversation-list__avatar">
              {% if other.profile_image %}
                <img src="{{ url_for('static', filename='uploads/' + other.profile_image) }}" alt="{{ other.name }}">
              {% else %}
                {{ other.name[0]|upper }}
              {% endif %}
            </div>
            <div class="conversation-list__body">
              <div class="conversation-list__row">
                <span class="conversation-list__name">{{ other.name }}</span>
                <time class="conversation-list__time">{{ conv.last_message.timestamp.strftime('%b %d • %I:%M %p') }}</time>
              </div>
              <p class="conversation-list__preview">
                {% if conv.last_message.sender_id == current_user.user_id %}
                  You:
                {% endif %}
                {{ conv.last_message.get_preview(80) }}
              </p>
              <div class="conversation-list__badges">
                {% if conv.unread_count > 0 %}
                  <span class="conversation-list__unread" data-unread-badge>{{ conv.unread_count }}</span>
                {% endif %}
                <span class="badge badge--ghost">{{ conv.message_count }} msg{{ '' if conv.message_count == 1 else 's' }}</span>
              </div>
            </div>
          </a>
        {% endfor %}
      {% else %}
        <div class="messages-empty">
          <i data-lucide="inbox" class="icon icon-lg"></i>
          <h2>No conversations yet</h2>
          <p>Message a resource owner to start collaborating.</p>
          <a href="{{ url_for('resources.index') }}" class="ui-button ui-button--primary">
            Browse resources
          </a>
        </div>
      {% endif %}
    </div>
  </div>

  <section class="messages-thread">
    {% if active_user %}
      <article class="ui-card messages-thread__panel">
        <header class="messages-thread__header">
          <button type="button" class="ui-button ui-button--ghost" data-back-to-list aria-label="Back to inbox">
            <i data-lucide="arrow-left" class="icon icon-sm"></i>
            <span>Inbox</span>
          </button>
          <div class="messages-thread__user">
            <div class="messages-thread__user-avatar">
              {% if active_user.profile_image %}
                <img src="{{ url_for('static', filename='uploads/' + active_user.profile_image) }}" alt="{{ active_user.name }}">
              {% else %}
                {{ active_user.name[0]|upper }}
              {% endif %}
            </div>
            <div class="messages-thread__user-meta">
              <h2>{{ active_user.name }}</h2>
              <p>{{ active_user.email }}</p>
            </div>
          </div>
          <div class="messages-thread__actions">
            <button type="button" class="ui-button ui-button--ghost" aria-label="Conversation options">
              <i data-lucide="more-horizontal" class="icon icon-sm"></i>
            </button>
          </div>
        </header>

        <div class="messages-thread__messages" data-thread>
          {% if active_messages %}
            {% for message in active_messages %}
              {% set is_sender = message.sender_id == current_user.user_id %}
              <article class="message-bubble {{ 'message-bubble--sent' if is_sender else 'message-bubble--received' }}">
                <div class="message-bubble__body">
                  {{ message.content | replace('\n', '<br>') | safe }}
                </div>
                <div class="message-bubble__meta">
                  <time>{{ message.timestamp.strftime('%b %d, %I:%M %p') }}</time>
                  {% if is_sender %}
                    <span>
                      {% if message.is_read %}
                        <i data-lucide="check-check" class="icon icon-xs"></i> Read
                      {% else %}
                        <i data-lucide="check" class="icon icon-xs"></i> Sent
                      {% endif %}
                    </span>
                  {% endif %}
                </div>
              </article>
            {% endfor %}
          {% else %}
            <div class="messages-empty">
              <i data-lucide="messages-square" class="icon icon-lg"></i>
              <h2>No messages yet</h2>
              <p>Say hello to start the conversation.</p>
            </div>
          {% endif %}
        </div>

        <form method="POST" action="{{ url_for('messages.send') }}" class="messages-thread__composer" data-composer>
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="receiver_id" value="{{ active_user.user_id }}">
          <label class="ui-field">
            <span class="ui-field__label">Message {{ active_user.name }}</span>
            <textarea
              name="content"
              rows="3"
              placeholder="Type your reply…"
              required
              maxlength="10000"
              class="ui-input messages-thread__input"
              data-composer-input></textarea>
          </label>
          <div class="messages-thread__composer-actions">
            <span class="composer-hint">Cmd/Ctrl + Enter to send</span>
            <div class="messages-thread__action-buttons">
              <button type="button" class="ui-button ui-button--ghost" data-attach-trigger>
                <i data-lucide="paperclip" class="icon icon-sm"></i>
                Attach
              </button>
              <input type="file" data-attach-input hidden>
              <button type="submit" class="ui-button ui-button--primary conversation-view__send-btn">
                <i data-lucide="send" class="icon icon-sm"></i>
                <span>Send</span>
              </button>
            </div>
          </div>
        </form>
      </article>
    {% else %}
      <article class="ui-card messages-thread__panel">
        <div class="messages-empty">
          <i data-lucide="message-square" class="icon icon-lg"></i>
          <h2>Select a conversation</h2>
          <p>Choose someone from the inbox to view your messages.</p>
        </div>
      </article>
    {% endif %}
  </section>
</section>
{% endblock %}

{% block extra_js %}
  <script type="module" src="{{ vite_asset('src/static/js/messages.js') }}"></script>
  <script type="module">
    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }
  </script>
{% endblock %}
