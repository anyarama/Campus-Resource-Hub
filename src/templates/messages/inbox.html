{% extends "base.html" %}

{% block title %}Messages{% endblock %}

{% block main_content %}
<div class="messages-page" data-messages-page>
  <aside class="conversations-sidebar">
    <div class="conversations-sidebar__header">
      <h1>Inbox</h1>
      <div class="conversations-sidebar__search">
        <i data-lucide="search" class="icon icon-sm"></i>
        <input type="search" placeholder="Search conversations" autocomplete="off" data-conversation-search class="form-control">
      </div>
      <div class="conversation-metrics">
        <span><i data-lucide="mail" class="icon icon-sm"></i>{{ stats.total_received }} received</span>
        <span><i data-lucide="send" class="icon icon-sm"></i>{{ stats.total_sent }} sent</span>
        <span><i data-lucide="bell" class="icon icon-sm"></i>{{ stats.unread }} unread</span>
      </div>
    </div>
    <div class="conversations-sidebar__list" data-conversation-list>
      {% if conversations %}
        {% for conv in conversations %}
          {% set other = conv.other_user %}
          <a href="{{ url_for('messages.inbox', user_id=other.user_id) }}"
             class="conversation-item {% if selected_user_id == other.user_id %}is-active{% endif %} {% if conv.unread_count > 0 %}is-unread{% endif %}"
             data-conversation-link>
            <div class="conversation-item__avatar">
              {% if other.profile_image %}
                <img src="{{ url_for('static', filename='uploads/' + other.profile_image) }}" alt="{{ other.name }}">
              {% else %}
                {{ other.name[0]|upper }}
              {% endif %}
            </div>
            <div class="conversation-item__content">
              <div class="conversation-item__header">
                <span class="conversation-item__name">{{ other.name }}</span>
                <time class="conversation-item__time">{{ conv.last_message.timestamp.strftime('%b %d â€¢ %I:%M %p') }}</time>
              </div>
              <p class="conversation-item__preview">
                {% if conv.last_message.sender_id == current_user.user_id %}
                  You:
                {% endif %}
                {{ conv.last_message.get_preview(80) }}
              </p>
              <div class="conversation-item__badges">
                {% if conv.unread_count > 0 %}
                  <span class="conversation-item__unread-badge" data-unread-badge>{{ conv.unread_count }}</span>
                {% endif %}
                <span class="badge badge--ghost">{{ conv.message_count }} msg{{ '' if conv.message_count == 1 else 's' }}</span>
              </div>
            </div>
          </a>
        {% endfor %}
      {% else %}
        <div class="conversation-view__empty">
          <i data-lucide="inbox" class="icon icon-sm"></i>
          <h2>No conversations yet</h2>
          <p>Message a resource owner to start a thread.</p>
          <a href="{{ url_for('resources.index') }}" class="btn btn--primary">Browse resources</a>
        </div>
      {% endif %}
    </div>
  </aside>

  <section class="conversation-view">
    {% if active_user %}
      <header class="conversation-view__header">
        <button type="button" class="conversation-view__back-btn btn btn--primary" data-back-to-list aria-label="Back to inbox">
          <i data-lucide="arrow-left" class="icon icon-sm"></i>
        </button>
        <div class="conversation-view__user-info">
          <div class="conversation-view__user-avatar">
            {% if active_user.profile_image %}
              <img src="{{ url_for('static', filename='uploads/' + active_user.profile_image) }}" alt="{{ active_user.name }}">
            {% else %}
              {{ active_user.name[0]|upper }}
            {% endif %}
          </div>
          <div class="conversation-view__user-details">
            <h2>{{ active_user.name }}</h2>
            <p>{{ active_user.email }}</p>
          </div>
        </div>
        <div class="conversation-view__actions">
          <button type="button" aria-label="More options" class="btn btn--primary">
            <i data-lucide="more-horizontal" class="icon icon-sm"></i>
          </button>
        </div>
      </header>

      <div class="conversation-view__messages" data-thread>
        {% if active_messages %}
          {% for message in active_messages %}
            {% set is_sender = message.sender_id == current_user.user_id %}
            <article class="message-bubble {{ 'message-bubble--sent' if is_sender else 'message-bubble--received' }}">
              <div class="message-bubble__body">
                <p>{{ message.content | replace('\n', '<br>') | safe }}</p>
              </div>
              <div class="message-bubble__meta">
                <time>{{ message.timestamp.strftime('%b %d, %I:%M %p') }}</time>
                {% if is_sender %}
                  <span class="message-bubble__status">
                    {% if message.is_read %}
                      <i data-lucide="check-check" class="icon icon-sm"></i> Read
                    {% else %}
                      <i data-lucide="check" class="icon icon-sm"></i> Sent
                    {% endif %}
                  </span>
                {% endif %}
              </div>
            </article>
          {% endfor %}
        {% else %}
          <div class="conversation-view__empty">
            <i data-lucide="messages-square" class="icon icon-sm"></i>
            <h2>No messages yet</h2>
            <p>Say hello to start the conversation.</p>
          </div>
        {% endif %}
      </div>

      <div class="conversation-view__input-area">
        <form method="POST" action="{{ url_for('messages.send') }}" class="conversation-view__form" data-composer>
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="receiver_id" value="{{ active_user.user_id }}">

          <div class="conversation-view__input-wrapper">
            <textarea
              name="content"
              rows="2"
              placeholder="Message {{ active_user.name }}..."
              required
              maxlength="10000"
              data-composer-input
             class="form-control"></textarea>
            <button type="submit" class="btn btn--primary conversation-view__send-btn">
              <i data-lucide="send" class="icon icon-sm"></i>
              <span>Send</span>
            </button>
          </div>

          <div class="conversation-view__input-actions">
            <button type="button" aria-label="Attach file" data-attach-trigger class="btn btn--primary">
              <i data-lucide="paperclip" class="icon icon-sm"></i>Attach
            </button>
            <input type="file" data-attach-input hidden>
            <span class="composer-hint">Cmd/Ctrl + Enter to send</span>
          </div>
        </form>
      </div>
    {% else %}
      <div class="conversation-view__empty">
        <i data-lucide="message-square" class="icon icon-sm"></i>
        <h2>Select a conversation</h2>
        <p>Choose someone from the inbox to view your messages.</p>
      </div>
    {% endif %}
  </section>
</div>
{% endblock %}

{% block extra_js %}
  <script type="module" src="{{ vite_asset('src/static/js/messages.js') }}"></script>
  <script type="module">
    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }
  </script>
{% endblock %}
