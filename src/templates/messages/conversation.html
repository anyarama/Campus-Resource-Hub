{% extends "base.html" %}

{% block title %}Conversation with {{ other_user.name }}{% endblock %}

{% block main_content %}
<section class="messages-detail">
  <article class="ui-card messages-thread__panel">
    <header class="messages-thread__header">
      <div class="messages-thread__user">
        <div class="messages-thread__user-avatar">
          {% if other_user.profile_image %}
            <img src="{{ url_for('static', filename='uploads/' + other_user.profile_image) }}" alt="{{ other_user.name }}">
          {% else %}
            {{ other_user.name[0]|upper }}
          {% endif %}
        </div>
        <div class="messages-thread__user-meta">
          <h2>{{ other_user.name }}</h2>
          <p>{{ other_user.email }}</p>
        </div>
      </div>
      <div class="messages-thread__actions">
        <a href="{{ url_for('messages.inbox', user_id=other_user.user_id) }}" class="ui-button ui-button--ghost">
          <i data-lucide="arrow-left" class="icon icon-sm"></i>
          Back to inbox
        </a>
      </div>
    </header>

    <div class="messages-thread__messages" id="messagesContainer">
      {% if messages %}
        {% for message in messages %}
          {% set is_sender = message.sender_id == current_user.user_id %}
          <article class="message-bubble {{ 'message-bubble--sent' if is_sender else 'message-bubble--received' }}">
            <div class="message-bubble__body">
              {% if not is_sender %}
                <strong>{{ message.sender.name }} · </strong>
              {% endif %}
              {{ message.content | replace('\n', '<br>') | safe }}
            </div>
            <div class="message-bubble__meta">
              <time>{{ message.timestamp.strftime('%b %d, %Y · %I:%M %p') }}</time>
              {% if is_sender %}
                <span>
                  <i data-lucide="check" class="icon icon-xs"></i>
                  Sent
                </span>
              {% endif %}
              {% if is_sender %}
                <form method="POST" action="{{ url_for('messages.delete', message_id=message.message_id) }}" class="inline-form" onsubmit="return confirm('Delete this message?');">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <button type="submit" class="ui-button ui-button--ghost ui-button--sm" title="Delete message">
                    <i data-lucide="trash" class="icon icon-sm"></i>
                  </button>
                </form>
              {% endif %}
            </div>
          </article>
        {% endfor %}
      {% else %}
        <div class="messages-empty">
          <i data-lucide="message-square" class="icon icon-lg"></i>
          <p>No messages yet. Start the conversation below.</p>
        </div>
      {% endif %}
    </div>

    <form method="POST" action="{{ url_for('messages.send') }}" class="messages-thread__composer" id="replyForm">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="hidden" name="receiver_id" value="{{ other_user.user_id }}">
      <label class="ui-field">
        <span class="ui-field__label">Your message</span>
        <textarea
          class="ui-input messages-thread__input"
          id="content"
          name="content"
          rows="4"
          placeholder="Type your message here..."
          maxlength="10000"
          required></textarea>
      </label>
      <div class="messages-thread__composer-actions">
        <span class="composer-hint">
          <i data-lucide="info" class="icon icon-xs"></i>
          Messages are plain text only.
        </span>
        <button type="submit" class="ui-button ui-button--primary">
          <i data-lucide="send" class="icon icon-sm"></i>
          Send
        </button>
      </div>
    </form>
  </article>
</section>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('messagesContainer');
    if (container) {
      container.scrollTop = container.scrollHeight;
    }
  });
</script>
{% endblock %}
