{% extends "base.html" %}
{% block title %}User Management{% endblock %}

{% block main_content %}
<section class="admin-page__header">
  <div>
    <p class="eyebrow">Administration</p>
    <h1>User Management</h1>
    <p>Search, filter, and take action on platform accounts.</p>
  </div>
  <a href="{{ url_for('admin.dashboard') }}" class="btn btn--ghost">
    <i data-lucide="arrow-left"></i>
    <span>Back to dashboard</span>
  </a>
</section>

<form method="get" class="user-filter" aria-label="Filter users">
  <label>
    <span>Search</span>
    <input type="search" name="search" value="{{ search_term }}" placeholder="Name or email" autocomplete="off">
  </label>
  <label>
    <span>Role</span>
    <select name="role">
      <option value="">All roles</option>
      <option value="admin" {% if role_filter == 'admin' %}selected{% endif %}>Admin</option>
      <option value="staff" {% if role_filter == 'staff' %}selected{% endif %}>Staff</option>
      <option value="student" {% if role_filter == 'student' %}selected{% endif %}>Student</option>
    </select>
  </label>
  <label>
    <span>Status</span>
    <select name="status">
      <option value="">All statuses</option>
      <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Active</option>
      <option value="suspended" {% if status_filter == 'suspended' %}selected{% endif %}>Suspended</option>
    </select>
  </label>
  <button type="submit" class="btn btn--primary">
    <i data-lucide="search"></i>
    <span>Apply</span>
  </button>
</form>

<section class="user-metrics">
  <article>
    <p class="user-metrics__label">Total users</p>
    <p class="user-metrics__value">{{ total_users }}</p>
  </article>
  <article>
    <p class="user-metrics__label">Active</p>
    <p class="user-metrics__value text-success">{{ active_count }}</p>
  </article>
  <article>
    <p class="user-metrics__label">Suspended</p>
    <p class="user-metrics__value text-warning">{{ suspended_count }}</p>
  </article>
</section>

<section class="card">
  <header class="card__header">
    <div>
      <h2>Users</h2>
      <p class="text-muted">Use the checkboxes to perform bulk actions.</p>
    </div>
  </header>
  {% if users %}
  <form method="POST" action="{{ url_for('admin.bulk_update_users') }}" data-bulk-form>
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <input type="hidden" name="action" value="" data-bulk-action-input>
    <div class="bulk-toolbar">
      <span data-bulk-count>0 selected</span>
      <div class="bulk-toolbar__actions">
        <button type="submit" class="btn btn--ghost" data-bulk-action value="activate" disabled>
          <i data-lucide="play"></i>
          <span>Activate</span>
        </button>
        <button type="submit" class="btn btn--warning" data-bulk-action value="suspend" disabled>
          <i data-lucide="pause"></i>
          <span>Suspend</span>
        </button>
      </div>
    </div>
    <div class="table-scroll table-scroll--sticky" role="region">
      <table class="table table--sticky" role="table">
        <thead>
          <tr>
            <th scope="col">
              <label class="checkbox">
                <input type="checkbox" data-bulk-master aria-label="Select all users">
                <span></span>
              </label>
            </th>
            <th scope="col">User</th>
            <th scope="col">Role</th>
            <th scope="col">Department</th>
            <th scope="col">Status</th>
            <th scope="col">Joined</th>
            <th scope="col" class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for user in users %}
          <tr tabindex="0">
            <td data-label="Select">
              <label class="checkbox">
                <input type="checkbox" name="user_ids" value="{{ user.user_id }}" data-bulk-checkbox aria-label="Select {{ user.name }}">
                <span></span>
              </label>
            </td>
            <td data-label="User">
              <strong>{{ user.name }}</strong>
              <p class="text-muted">{{ user.email }}</p>
            </td>
            <td data-label="Role">
              {% if user.role == 'admin' %}
                <span class="chip chip--error">Admin</span>
              {% elif user.role == 'staff' %}
                <span class="chip chip--info">Staff</span>
              {% else %}
                <span class="chip chip--success">Student</span>
              {% endif %}
            </td>
            <td data-label="Department">{{ user.department or 'â€”' }}</td>
            <td data-label="Status">
              {% if user.is_active %}
                <span class="badge badge--success">Active</span>
              {% else %}
                <span class="badge badge--warning">Suspended</span>
              {% endif %}
            </td>
            <td data-label="Joined">{{ user.created_at.strftime('%b %d, %Y') }}</td>
            <td class="text-end">
              <div class="btn-group">
                <a href="{{ url_for('admin.user_detail', user_id=user.user_id) }}" class="btn btn--ghost btn--sm" title="View details">
                  <i data-lucide="eye"></i>
                </a>
                {% if user.role != 'admin' and user.user_id != current_user.user_id %}
                  {% if user.is_active %}
                    <form method="POST" action="{{ url_for('admin.suspend_user', user_id=user.user_id) }}" class="inline-form">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <button class="btn btn--warning btn--sm" title="Suspend user" onclick="return confirm('Suspend {{ user.name }}?');">
                        <i data-lucide="pause"></i>
                      </button>
                    </form>
                  {% else %}
                    <form method="POST" action="{{ url_for('admin.activate_user', user_id=user.user_id) }}" class="inline-form">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <button class="btn btn--success btn--sm" title="Activate user">
                        <i data-lucide="play"></i>
                      </button>
                    </form>
                  {% endif %}
                {% endif %}
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </form>
  {% else %}
    <div class="empty-state empty-state--inline">
      <i data-lucide="users"></i>
      <h3>No users match the filters</h3>
      <p>Try adjusting the search or filters above.</p>
    </div>
  {% endif %}
</section>
{% endblock %}

{% block extra_js %}
  <script type="module" src="{{ vite_asset('src/static/js/admin-dashboard.js') }}"></script>
  <script type="module">
    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }
  </script>
{% endblock %}
