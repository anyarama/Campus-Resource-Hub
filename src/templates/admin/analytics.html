{% extends "base.html" %}
{% block title %}Platform Analytics{% endblock %}

{% block main_content %}
<section class="admin-page__header">
  <div>
    <p class="eyebrow">Analytics</p>
    <h1>Usage Insights</h1>
    <p>Track bookings, category demand, and resource utilization.</p>
  </div>
  <form method="get" class="analytics-period" aria-label="Select reporting window">
    <select name="period" onchange="this.form.submit()" class="form-control">
      {% for option in [7, 30, 90] %}
        <option value="{{ option }}" {% if period == option %}selected{% endif %}>Last {{ option }} days</option>
      {% endfor %}
    </select>
  </form>
</section>

<section class="admin-analytics__grid">
  <article class="card admin-analytics__card admin-analytics__card--wide">
    <header class="card__header">
      <h2><i data-lucide="trending-up" class="icon icon-sm"></i> Bookings per day</h2>
      <small class="text-muted">Rolling window of {{ period }} days</small>
    </header>
    <canvas id="bookingsLineChart" role="img" aria-label="Bookings per day line chart"></canvas>
  </article>

  <article class="card admin-analytics__card">
    <header class="card__header">
      <h2><i data-lucide="bar-chart-3" class="icon icon-sm"></i> Popular categories</h2>
      <small class="text-muted">Bookings by resource type</small>
    </header>
    <canvas id="categoriesBarChart" role="img" aria-label="Popular categories bar chart"></canvas>
  </article>

  <article class="card admin-analytics__card">
    <header class="card__header">
      <h2><i data-lucide="pie-chart" class="icon icon-sm"></i> Utilization rate</h2>
      <small class="text-muted">Resources booked vs. available</small>
    </header>
    <canvas id="utilizationDoughnutChart" role="img" aria-label="Resource utilization chart"></canvas>
  </article>
</section>
{% endblock %}

{% block extra_js %}
  <script type="module">
    import { createLineChart, createDoughnutChart, createBarChart, IU_COLORS } from '{{ vite_asset("src/static/js/charts.js") }}';

    const analyticsData = {{ analytics_data|tojson }};

    const lineCanvas = document.getElementById('bookingsLineChart');
    const barCanvas = document.getElementById('categoriesBarChart');
    const doughnutCanvas = document.getElementById('utilizationDoughnutChart');

    const lineChart = createLineChart(lineCanvas, analyticsData.bookingsPerDay);
    const barChart = createBarChart(barCanvas, {
      labels: analyticsData.popularCategories.labels,
      datasets: [
        {
          label: 'Bookings',
          data: analyticsData.popularCategories.datasets[0].data,
          backgroundColor: IU_COLORS.crimson,
        },
      ],
    });

    const doughnutChart = createDoughnutChart(doughnutCanvas, analyticsData.utilization);

    window.addEventListener('beforeunload', () => {
      [lineChart, barChart, doughnutChart].forEach(chart => chart && chart.destroy());
    });

    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }
  </script>
{% endblock %}
