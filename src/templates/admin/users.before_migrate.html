{% extends "base.html" %}


{% block title %}User Management - Campus Resource Hub{% endblock %}

{% block extra_css %}
<style>
  .user-table {
    background: white;
  }
  .user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
  }
  .user-status-badge {
    font-size: 0.75rem;
  }
  .action-btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
  }
  .search-box {
    max-width: 400px;
  }
  .filter-badge {
    cursor: pointer;
    transition: all 0.2s;
  }
  .filter-badge:hover {
    transform: translateY(-1px);
  }
  .filter-badge.active {
    box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.5);
  }
</style>
{% endblock %}

{% block content %}
<div class="layout-grid">
  <div class="layout-col" data-col="12">
    <h1 class="h2"><i class="bi bi-people icon"></i> User Management</h1>
    <p class="text-muted">Manage platform users and permissions</p>
  </div>
  <div class="layout-col" data-col="12">
    <a href="{{ url_for('admin.dashboard') }}" class="btn btn-secondary">
      <i class="bi bi-arrow-left icon"></i> Back to Dashboard
    </a>
  </div>
</div>

<!-- Search & Filter Section -->
<div class="card">
  <div class="card-body">
    <form method="GET" action="{{ url_for('admin.users') }}" class="layout-grid g-3 align-items-end">
      <!-- Search -->
      <div class="layout-col" data-col="12">
        <label for="search" class="form-label">Search Users</label>
        <div class="input-group">
          <input type="text" class="form-control" id="search" name="search" 
              placeholder="Search by name or email..." value="{{ request.args.get('search', '') }}">
          <button class="btn btn-primary btn--primary" type="submit">
            <i class="bi bi-search icon"></i> Search
          </button>
        </div>
      </div>
      
      <!-- Role Filter -->
      <div class="layout-col" data-col="12">
        <label for="role" class="form-label">Role</label>
        <select class="form-select form-control" id="role" name="role" onchange="this.form.submit()">
          <option value="">All Roles</option>
          <option value="admin" {{ 'selected' if request.args.get('role') == 'admin' else '' }}>Admin</option>
          <option value="staff" {{ 'selected' if request.args.get('role') == 'staff' else '' }}>Staff</option>
          <option value="student" {{ 'selected' if request.args.get('role') == 'student' else '' }}>Student</option>
        </select>
      </div>
      
      <!-- Status Filter -->
      <div class="layout-col" data-col="12">
        <label for="status" class="form-label">Status</label>
        <select class="form-select form-control" id="status" name="status" onchange="this.form.submit()">
          <option value="">All Status</option>
          <option value="active" {{ 'selected' if request.args.get('status') == 'active' else '' }}>Active</option>
          <option value="suspended" {{ 'selected' if request.args.get('status') == 'suspended' else '' }}>Suspended</option>
        </select>
      </div>
    </form>
    
    <!-- Active Filters Display -->
    {% if request.args.get('search') or request.args.get('role') or request.args.get('status') %}
    <div class="mt-3">
      <strong>Active Filters:</strong>
      {% if request.args.get('search') %}
        <span class="badge badge-info">Search: {{ request.args.get('search') }}</span>
      {% endif %}
      {% if request.args.get('role') %}
        <span class="badge badge-primary">Role: {{ request.args.get('role') }}</span>
      {% endif %}
      {% if request.args.get('status') %}
        <span class="badge badge-secondary">Status: {{ request.args.get('status') }}</span>
      {% endif %}
      <a href="{{ url_for('admin.users') }}" class="badge badge-danger">
        <i class="bi bi-x icon"></i> Clear All
      </a>
    </div>
    {% endif %}
  </div>
</div>

<!-- User Statistics -->
<div class="layout-grid g-3">
  <div class="layout-col" data-col="12">
    <div class="card">
      <div class="card-body">
        <h3 class="mb-0">{{ users|length }}</h3>
        <p class="text-muted small">Total Users Shown</p>
      </div>
    </div>
  </div>
  <div class="layout-col" data-col="12">
    <div class="card">
      <div class="card-body">
        <h3 class="mb-0">{{ users|selectattr('is_active')|list|length }}</h3>
        <p class="text-muted small">Active</p>
      </div>
    </div>
  </div>
  <div class="layout-col" data-col="12">
    <div class="card">
      <div class="card-body">
        <h3 class="mb-0">{{ users|rejectattr('is_active')|list|length }}</h3>
        <p class="text-muted small">Suspended</p>
      </div>
    </div>
  </div>
  <div class="layout-col" data-col="12">
    <div class="card">
      <div class="card-body">
        <h3 class="mb-0 text-primary">{{ page }}</h3>
        <p class="text-muted small">Current Page</p>
      </div>
    </div>
  </div>
</div>

<!-- Users Table -->
<div class="card">
  <div class="card-header">
    <h5 class="mb-0">Users List</h5>
  </div>
  <div class="card-body">
    {% if users %}
    <div class="table-responsive">
      <table class="table table-hover user-table table--interactive">
        <thead class="table-light">
          <tr>
            <th>User</th>
            <th>Email</th>
            <th>Role</th>
            <th>Department</th>
            <th>Status</th>
            <th>Joined</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for user in users %}
          <tr>
            <td>
              <div class="d-flex">
                {% if user.profile_image %}
                  <img src="{{ url_for('static', filename='uploads/' + user.profile_image) }}" 
                     alt="{{ user.name }}" class="user-avatar">
                {% else %}
                  <div class="user-avatar bg-secondary text-white">
                    {{ user.name[0].upper() }}
                  </div>
                {% endif %}
                <a href="{{ url_for('admin.user_detail', user_id=user.user_id) }}" class="text-decoration-none">
                  <strong>{{ user.name }}</strong>
                </a>
              </div>
            </td>
            <td>{{ user.email }}</td>
            <td>
              {% if user.role == 'admin' %}
                <span class="badge badge-danger">Admin</span>
              {% elif user.role == 'staff' %}
                <span class="badge badge-primary">Staff</span>
              {% else %}
                <span class="badge badge-secondary">Student</span>
              {% endif %}
            </td>
            <td>{{ user.department or '-' }}</td>
            <td>
              {% if user.is_active %}
                <span class="badge badge-success user-status-badge">
                  <i class="bi bi-check-circle icon"></i> Active
                </span>
              {% else %}
                <span class="badge badge-danger user-status-badge">
                  <i class="bi bi-x-circle icon"></i> Suspended
                </span>
              {% endif %}
            </td>
            <td>{{ user.created_at.strftime('%b %d, %Y') }}</td>
            <td class="text-end">
              <div class="btn-group">
                <a href="{{ url_for('admin.user_detail', user_id=user.user_id) }}" 
                  class="btn btn-outline-info action-btn" title="View Details">
                  <i class="bi bi-eye icon"></i>
                </a>
                
                {% if user.role != 'admin' and user.user_id != current_user.user_id %}
                  {% if user.is_active %}
                    <button type="button" class="btn btn-outline-warning action-btn btn--primary" 
                        data-bs-toggle="modal" data-bs-target="#suspendModal{{ user.user_id }}"
                        title="Suspend User">
                      <i class="bi bi-pause-circle icon"></i>
                    </button>
                  {% else %}
                    <form method="POST" action="{{ url_for('admin.activate_user', user_id=user.user_id) }}" 
                       style="display: inline;" onsubmit="return confirm('Activate this user?');">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                      <button type="submit" class="btn btn-outline-success action-btn btn--primary" title="Activate User">
                        <i class="bi bi-play-circle icon"></i>
                      </button>
                    </form>
                  {% endif %}
                  
                  <button type="button" class="btn btn-outline-danger action-btn btn--primary" 
                      data-bs-toggle="modal" data-bs-target="#deleteModal{{ user.user_id }}"
                      title="Delete User">
                    <i class="bi bi-trash icon"></i>
                  </button>
                {% endif %}
              </div>
            </td>
          </tr>
          
          <!-- Suspend Modal -->
          <div class="modal fade" id="suspendModal{{ user.user_id }}" tabindex="-1">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Suspend User</h5>
                  <button type="button" class="btn-close btn btn--primary" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <p>Are you sure you want to suspend <strong>{{ user.name }}</strong>?</p>
                  <p class="text-muted small">Suspended users cannot log in or access the platform.</p>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary btn--primary" data-bs-dismiss="modal">Cancel</button>
                  <form method="POST" action="{{ url_for('admin.suspend_user', user_id=user.user_id) }}" style="display: inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <button type="submit" class="btn btn-warning btn--primary">Suspend User</button>
                  </form>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Delete Modal -->
          <div class="modal fade" id="deleteModal{{ user.user_id }}" tabindex="-1">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                  <h5 class="modal-title">Delete User</h5>
                  <button type="button" class="btn-close btn-close-white btn btn--primary" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <p><strong>⚠️ WARNING: This action cannot be undone!</strong></p>
                  <p>Are you sure you want to permanently delete <strong>{{ user.name }}</strong>?</p>
                  <p class="text-muted small">This will delete:</p>
                  <ul class="text-muted small">
                    <li>User account and profile</li>
                    <li>All resources owned by this user</li>
                    <li>All bookings made by this user</li>
                    <li>All messages sent/received</li>
                    <li>All reviews written</li>
                  </ul>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary btn--primary" data-bs-dismiss="modal">Cancel</button>
                  <form method="POST" action="{{ url_for('admin.delete_user', user_id=user.user_id) }}" style="display: inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <button type="submit" class="btn btn-danger btn--primary">Delete Permanently</button>
                  </form>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="text-center">
      <i class="bi bi-inbox fs-1 icon"></i>
      <p class="text-muted">No users found matching your criteria.</p>
      <a href="{{ url_for('admin.users') }}" class="btn btn-secondary">Clear Filters</a>
    </div>
    {% endif %}
  </div>
  
  <!-- Pagination -->
  {% if total_pages > 1 %}
  <div class="card-footer">
    <nav>
      <ul class="pagination">
        <li class="page-item {{ 'disabled' if page == 1 else '' }}">
          <a class="page-link" href="{{ url_for('admin.users', page=page-1, search=request.args.get('search', ''), role=request.args.get('role', ''), status=request.args.get('status', '')) }}">
            Previous
          </a>
        </li>
        
        {% for p in range(1, total_pages + 1) %}
          {% if p == page %}
            <li class="page-item active"><span class="page-link">{{ p }}</span></li>
          {% elif p == 1 or p == total_pages or (p >= page - 2 and p <= page + 2) %}
            <li class="page-item">
              <a class="page-link" href="{{ url_for('admin.users', page=p, search=request.args.get('search', ''), role=request.args.get('role', ''), status=request.args.get('status', '')) }}">
                {{ p }}
              </a>
            </li>
          {% elif p == page - 3 or p == page + 3 %}
            <li class="page-item disabled"><span class="page-link">...</span></li>
          {% endif %}
        {% endfor %}
        
        <li class="page-item {{ 'disabled' if page == total_pages else '' }}">
          <a class="page-link" href="{{ url_for('admin.users', page=page+1, search=request.args.get('search', ''), role=request.args.get('role', ''), status=request.args.get('status', '')) }}">
            Next
          </a>
        </li>
      </ul>
    </nav>
  </div>
  {% endif %}
</div>

{% endblock %}
