{% extends "base.html" %}

{% block title %}Booking Details - {{ resource.title }}{% endblock %}

{% block content %}
<div class="page-header">
  <div>
    <p class="eyebrow">Booking</p>
    <h1>{{ resource.title }}</h1>
    <p class="text-dim">Review the request, take action, and message the owner if you need more info.</p>
  </div>
</div>

<div class="layout-grid gap-lg">
  <div class="layout-col" data-col-lg="8">
    <div class="card">
      <div class="card-body">
        <div class="space-b-3">
          <h2 class="space-b-1">Reservation details</h2>
          <p class="text-dim">Requested by {{ requester.name }} ({{ requester.email }})</p>
        </div>

        <div class="layout-grid gap-sm">
          <div class="layout-col" data-col="6">
            <h6 class="text-dim"><i class="bi bi-calendar-event icon"></i> Start</h6>
            <p>{{ booking.start_datetime.strftime('%B %d, %Y') }}<br><strong>{{ booking.start_datetime.strftime('%I:%M %p') }}</strong></p>
          </div>
          <div class="layout-col" data-col="6">
            <h6 class="text-dim"><i class="bi bi-calendar-x icon"></i> End</h6>
            <p>{{ booking.end_datetime.strftime('%B %d, %Y') }}<br><strong>{{ booking.end_datetime.strftime('%I:%M %p') }}</strong></p>
          </div>
        </div>

        {% set duration = (booking.end_datetime - booking.start_datetime).total_seconds() %}
        {% set hours = (duration // 3600)|int %}
        {% set minutes = ((duration % 3600) // 60)|int %}
        <p class="text-dim space-b-3">
          <i class="bi bi-clock icon"></i>
          Duration: {% if hours %}{{ hours }} hour{{ '' if hours == 1 else 's' }} {% endif %}{% if minutes %}{{ minutes }} minute{{ '' if minutes == 1 else 's' }}{% endif %}
        </p>

        {% if booking.notes %}
        <div class="space-b-3">
          <h6 class="text-dim"><i class="bi bi-chat-left-text icon"></i> Notes</h6>
          <p>{{ booking.notes }}</p>
        </div>
        {% endif %}

        {% if booking.status == 'rejected' and booking.rejection_reason %}
        <div class="alert alert-danger space-b-3">
          <h6 class="alert-heading"><i class="bi bi-exclamation-triangle icon"></i> Rejection reason</h6>
          <p class="space-b-0">{{ booking.rejection_reason }}</p>
        </div>
        {% endif %}

        <div class="space-t-4 pad-t-3 border-top">
          <small class="text-dim">
            <i class="bi bi-clock-history icon"></i> Created {{ booking.created_at.strftime('%B %d, %Y at %I:%M %p') }}
            {% if booking.updated_at and booking.updated_at != booking.created_at %}
              <br>
              <i class="bi bi-arrow-clockwise icon"></i> Updated {{ booking.updated_at.strftime('%B %d, %Y at %I:%M %p') }}
            {% endif %}
          </small>
        </div>
      </div>
    </div>
  </div>

  <div class="layout-col" data-col-lg="4">
    <div class="card space-b-3">
      <div class="card-header">
        <h3 class="space-b-0"><i class="bi bi-lightning-charge icon"></i> Actions</h3>
      </div>
      <div class="card-body stack-sm">
        {% if booking.status == 'pending' and (current_user.role in ['staff', 'admin'] or current_user.user_id == resource.owner_id) %}
          <form method="POST" action="{{ url_for('bookings.approve', booking_id=booking.booking_id) }}" class="stack-sm">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-success btn--primary">
              <i class="bi bi-check-circle icon"></i> Approve booking
            </button>
          </form>
          <button type="button" class="btn btn-danger btn--primary" data-modal-open="rejectModal">
            <i class="bi bi-x-circle icon"></i> Reject booking
          </button>
        {% endif %}

        {% if booking.status in ['pending', 'approved'] and current_user.user_id == booking.requester_id %}
          <form method="POST" action="{{ url_for('bookings.cancel', booking_id=booking.booking_id) }}" onsubmit="return confirm('Cancel this booking?');" class="stack-sm">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-warning btn--primary">
              <i class="bi bi-x-circle icon"></i> Cancel booking
            </button>
          </form>
        {% endif %}

        {% if booking.status == 'approved' and current_user.role == 'admin' %}
          <form method="POST" action="{{ url_for('bookings.complete', booking_id=booking.booking_id) }}" onsubmit="return confirm('Mark as complete?');" class="stack-sm">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-primary btn--primary">
              <i class="bi bi-check-all icon"></i> Mark complete
            </button>
          </form>
        {% endif %}

        {% if booking.status == 'completed' and current_user.user_id == booking.requester_id %}
          <a href="{{ url_for('resources.detail', resource_id=resource.resource_id) }}#reviews" class="btn btn-secondary">
            <i class="bi bi-star icon"></i> Leave a review
          </a>
        {% endif %}

        <a href="{{ url_for('bookings.my_bookings') }}" class="btn btn-outline">
          <i class="bi bi-arrow-left icon"></i> Back to My Bookings
        </a>
      </div>
    </div>

    {% if current_user.user_id != resource.owner_id %}
      <div class="card space-b-3">
        <div class="card-header">
          <h3 class="space-b-0"><i class="bi bi-chat-dots icon"></i> Contact owner</h3>
        </div>
        <div class="card-body">
          <p class="text-dim">Have a question about this booking? Send a quick message.</p>
          <a href="{{ url_for('messages.compose', user_id=resource.owner_id) }}" class="btn btn-secondary">
            <i class="bi bi-envelope icon"></i> Message owner
          </a>
        </div>
      </div>
    {% endif %}
  </div>
</div>

<div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true" data-modal>
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="POST" action="{{ url_for('bookings.reject', booking_id=booking.booking_id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="modal-header">
          <h5 class="modal-title" id="rejectModalLabel"><i class="bi bi-x-circle icon"></i> Reject booking</h5>
          <button type="button" class="btn-close btn btn--primary" data-modal-close aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="space-b-3">
            <label for="rejection_reason" class="form-label">Reason for rejection</label>
            <textarea id="rejection_reason" name="rejection_reason" class="form-control" rows="3" required placeholder="Let the requester know why the booking was rejected."></textarea>
            <div class="form-text">This message is shared with the requester.</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary btn--primary" data-modal-close>Cancel</button>
          <button type="submit" class="btn btn-danger btn--primary">
            <i class="bi bi-x-circle icon"></i> Reject booking
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}
