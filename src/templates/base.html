<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    {% set canonical_href = canonical_url if canonical_url is defined else (request.url_root.rstrip('/') ~ request.path) %}
    <title>{% block title %}Campus Resource Hub{% endblock %}</title>
    <meta name="description" content="{{ page_description | default('Campus Resource Hub helps students discover, book, and manage campus resources with accessible enterprise-grade tooling.') }}">
    <meta name="theme-color" content="#111827">
    <meta name="color-scheme" content="light dark">
    <meta name="robots" content="index,follow">
    <link rel="canonical" href="{{ canonical_href }}">
    <link rel="stylesheet" href="{{ asset_url('app.css') }}">

    {% block meta_tags %}{% endblock %}
    {% block extra_css %}{% endblock %}
</head>
<body data-theme="light">
    <a href="#main" class="skip-link">Skip to main content</a>
{% import 'components/shell.html' as ui_shell %}

    {% if current_user.is_authenticated %}
        {% set primary_nav = [
            {'endpoint': 'resources.dashboard', 'icon': 'house-door', 'label': 'Dashboard', 'match': ['resources.dashboard']},
            {'endpoint': 'resources.index', 'icon': 'grid-3x3-gap', 'label': 'Browse Resources', 'match': ['resources.index', 'resources.detail']},
            {'endpoint': 'resources.my_resources', 'icon': 'box-seam', 'label': 'My Resources', 'match': ['resources.my_resources']},
            {'endpoint': 'bookings.my_bookings', 'icon': 'calendar-check', 'label': 'My Bookings', 'match': ['bookings.my_bookings']},
            {'endpoint': 'messages.inbox', 'icon': 'envelope', 'label': 'Messages', 'match': ['messages.inbox', 'messages.conversation'], 'badge_id': 'msgBadge'},
            {'endpoint': 'concierge.index', 'icon': 'robot', 'label': 'AI Concierge', 'match': ['concierge.index']}
        ] %}
        {% set admin_nav = [
            {'endpoint': 'admin.dashboard', 'icon': 'speedometer2', 'label': 'Admin Dashboard', 'match': ['admin.dashboard']},
            {'endpoint': 'admin.users', 'icon': 'people', 'label': 'Users', 'match': ['admin.users', 'admin.user_detail']},
            {'endpoint': 'admin.analytics', 'icon': 'graph-up', 'label': 'Analytics', 'match': ['admin.analytics']}
        ] %}
    {% else %}
        {% set primary_nav = [] %}
        {% set admin_nav = [] %}
    {% endif %}

    {% call ui_shell.render_shell(current_user=current_user, request=request, primary_nav=primary_nav, admin_nav=admin_nav) %}
        <div class="{% if current_user.is_authenticated %}page-content{% else %}container{% endif %}">
            {% if current_user.is_authenticated %}
                {% block breadcrumbs %}{% endblock %}

                {% block page_header %}
                <div class="page-header">
                    <h1>{% block page_title %}{% endblock %}</h1>
                    <div class="page-toolbar">
                        {% block toolbar %}{% endblock %}
                    </div>
                </div>
                {% endblock %}
            {% endif %}

            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="flash-message" data-type="{{ 'error' if category == 'error' else category }}" style="display: none;">
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            {% block main_content %}
              {% block content %}{% endblock %}
            {% endblock %}
        </div>

        {% if current_user.is_authenticated %}
            {% include "components/booking_drawer.html" %}
            <div class="sidebar-overlay"></div>
        {% endif %}
    {% endcall %}

    <script defer src="{{ asset_url('enterprise.js') }}"></script>
    {% block extra_js %}{% endblock %}
</body>
</html>
