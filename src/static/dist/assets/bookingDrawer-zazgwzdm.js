class l{constructor(){this.drawer=document.getElementById("bookingDrawer"),this.drawer&&(this.form=this.drawer.querySelector("[data-booking-form]"),this.dateInput=this.drawer.querySelector("[data-booking-date]"),this.purposeInput=this.drawer.querySelector("[data-booking-purpose]"),this.durationSelect=this.drawer.querySelector("[data-duration-select]"),this.resetBtn=this.drawer.querySelector("[data-booking-reset]"),this.slotGrid=this.drawer.querySelector("[data-time-slot-grid]"),this.messageEl=this.drawer.querySelector("[data-booking-message]"),this.confirmation=this.drawer.querySelector("[data-booking-confirmation]"),this.editBtn=this.drawer.querySelector("[data-booking-edit]"),this.completeBtn=this.drawer.querySelector("[data-booking-complete]"),this.titleEl=this.drawer.querySelector("[data-booking-title]"),this.hiddenResourceId=this.drawer.querySelector("[data-booking-resource-id]"),this.hiddenBookingUrl=this.drawer.querySelector("[data-booking-url]"),this.hiddenAvailabilityUrl=this.drawer.querySelector("[data-availability-url]"),this.summaryFields={date:this.drawer.querySelector("[data-summary-date]"),time:this.drawer.querySelector("[data-summary-time]"),duration:this.drawer.querySelector("[data-summary-duration]"),purpose:this.drawer.querySelector("[data-summary-purpose]"),note:this.drawer.querySelector("[data-summary-note]")},this.currentResource=null,this.bookings=[],this.requiresApproval=!1,this.selectedRange=null,this.slotButtons=[],this.initSlotGrid(),this.attachGlobalListeners(),this.attachFormListeners(),this.setDateBounds())}attachGlobalListeners(){document.addEventListener("click",t=>{const e=t.target.closest("[data-booking-open]");e&&(t.preventDefault(),this.openDrawer({id:e.dataset.resourceId,title:e.dataset.resourceTitle,bookingUrl:e.dataset.bookingUrl,availabilityUrl:e.dataset.availabilityUrl}))})}attachFormListeners(){var t,e,s,i,r;this.form&&(this.form.addEventListener("submit",a=>{a.preventDefault(),this.handleSubmit()}),(t=this.dateInput)==null||t.addEventListener("change",()=>{this.clearSelection(),this.fetchAvailability()}),(e=this.durationSelect)==null||e.addEventListener("change",()=>{if(!this.selectedRange)return;const a=this.getRequiredSlots();this.canSelectRange(this.selectedRange.startIndex,a)?(this.selectedRange.slots=a,this.updateSelectionStyles(),this.updateMessage()):(this.clearSelection(),this.showMessage("error","Not enough time available for that duration."))}),(s=this.resetBtn)==null||s.addEventListener("click",()=>{this.resetFormState(),this.fetchAvailability()}),(i=this.editBtn)==null||i.addEventListener("click",()=>{this.showFormView()}),(r=this.completeBtn)==null||r.addEventListener("click",()=>{this.completeBooking()}),document.addEventListener("click",a=>{const o=a.target.closest("[data-drawer-close]");o&&this.drawer.contains(o)&&this.resetFormState()}))}setDateBounds(){if(!this.dateInput)return;const t=this.formatDateInput(new Date);this.dateInput.min=t}initSlotGrid(){if(!this.slotGrid)return;this.slotGrid.innerHTML="",this.slotButtons=[];let t=0;for(let e=420;e<1320;e+=30){const s=document.createElement("button");s.type="button",s.className="time-slot",s.dataset.index=String(t),s.dataset.minutes=String(e),s.setAttribute("role","gridcell"),s.setAttribute("aria-pressed","false"),s.textContent=this.formatMinutes(e),s.addEventListener("click",()=>this.handleSlotClick(t)),this.slotGrid.appendChild(s),this.slotButtons.push(s),t+=1}}openDrawer(t){if(!this.drawer)return;this.resetFormState(),this.currentResource=t,this.titleEl&&(this.titleEl.textContent=`Book ${t.title}`),this.hiddenResourceId&&(this.hiddenResourceId.value=t.id),this.hiddenBookingUrl&&(this.hiddenBookingUrl.value=t.bookingUrl),this.hiddenAvailabilityUrl&&(this.hiddenAvailabilityUrl.value=t.availabilityUrl);const e=this.formatDateInput(new Date);this.dateInput&&(this.dateInput.value=e),this.showMessage("info","Select a time to begin."),this.fetchAvailability(),window.drawer&&typeof window.drawer.open=="function"?window.drawer.open("bookingDrawer"):this.drawer.classList.add("open")}async fetchAvailability(){if(!this.currentResource||!this.dateInput||!this.hiddenAvailabilityUrl)return;const t=this.dateInput.value;if(!t){this.showMessage("info","Pick a date to view availability.");return}this.setSlotGridBusy(!0);try{const e=new URL(this.hiddenAvailabilityUrl.value,window.location.origin);e.searchParams.set("date",t);const s=await fetch(e),i=await s.json();if(!s.ok)throw new Error(i.error||"Unable to load availability.");this.bookings=i.bookings.map(r=>({start:new Date(r.start),end:new Date(r.end)})),this.requiresApproval=!!i.requires_approval,this.renderAvailability(t),this.updateMessage()}catch(e){this.bookings=[],this.showMessage("error",e.message||"Failed to load availability."),this.disableAllSlots(!0)}finally{this.setSlotGridBusy(!1)}}renderAvailability(t){const e=new Date(`${t}T00:00:00`);this.slotButtons.forEach(s=>{const i=Number(s.dataset.minutes),r=this.combineDate(e,i),a=this.combineDate(e,i+30),o=this.bookings.some(n=>r<n.end&&a>n.start);s.disabled=o,s.setAttribute("aria-disabled",o?"true":"false"),s.classList.toggle("is-blocked",o)}),this.clearSelection()}disableAllSlots(t){this.slotButtons.forEach(e=>{e.disabled=t,e.setAttribute("aria-disabled",t?"true":"false"),e.classList.toggle("is-blocked",t),e.classList.remove("is-selected")}),this.selectedRange=null}handleSlotClick(t){var s;if(!this.dateInput||!this.dateInput.value){this.showMessage("error","Choose a date first."),(s=this.dateInput)==null||s.focus();return}const e=this.getRequiredSlots();if(!this.canSelectRange(t,e)){this.showMessage("error","Already booked during part of this time.");return}this.selectedRange={startIndex:t,slots:e},this.updateSelectionStyles(),this.updateMessage()}canSelectRange(t,e){const s=t+e;if(s>this.slotButtons.length)return!1;for(let i=t;i<s;i+=1){const r=this.slotButtons[i];if(!r||r.disabled)return!1}return!0}updateSelectionStyles(){this.slotButtons.forEach((t,e)=>{const s=this.selectedRange?e>=this.selectedRange.startIndex&&e<this.selectedRange.startIndex+this.selectedRange.slots:!1;t.classList.toggle("is-selected",!!s),t.setAttribute("aria-pressed",s?"true":"false")})}clearSelection(){this.selectedRange=null,this.slotButtons.forEach(t=>{t.classList.remove("is-selected"),t.setAttribute("aria-pressed","false")})}handleSubmit(){var e;if(!this.selectedRange){this.showMessage("error","Select a time slot first.");return}if(!this.purposeInput.value.trim()){this.showMessage("error","Purpose is required."),this.purposeInput.focus();return}const t=this.getSelectionWindow();if(!t){this.showMessage("error","Invalid time selection.");return}this.populateSummary(t),this.showConfirmationView(),this.showMessage("success","Slot reserved! Complete booking to finalize."),(e=window.toast)!=null&&e.success&&window.toast.success("Time slot drafted! Complete the booking to finish.")}populateSummary(t){const{dateLabel:e,timeLabel:s,durationLabel:i,purposeLabel:r,noteLabel:a}=t;this.summaryFields.date&&(this.summaryFields.date.textContent=e),this.summaryFields.time&&(this.summaryFields.time.textContent=s),this.summaryFields.duration&&(this.summaryFields.duration.textContent=i),this.summaryFields.purpose&&(this.summaryFields.purpose.textContent=r),this.summaryFields.note&&(this.summaryFields.note.textContent=a)}showFormView(){!this.form||!this.confirmation||(this.form.hidden=!1,this.confirmation.hidden=!0)}showConfirmationView(){!this.form||!this.confirmation||(this.form.hidden=!0,this.confirmation.hidden=!1)}completeBooking(){var s;if(!this.currentResource)return;const t=this.getSelectionWindow();if(!t)return;const e=new URLSearchParams;e.set("resource_id",this.currentResource.id),e.set("date",t.dateISO),e.set("start",t.startTime),e.set("end",t.endTime),e.set("duration",t.durationMinutes),(s=this.purposeInput)!=null&&s.value&&e.set("purpose",this.purposeInput.value.trim()),window.location.href=`${this.currentResource.bookingUrl}?${e.toString()}`}updateMessage(){if(!this.selectedRange){this.clearMessage(),this.requiresApproval&&this.showMessage("info","Requires approval: owner will confirm before booking.");return}this.requiresApproval?this.showMessage("info","Requires approval: owner will review this request."):this.clearMessage()}showMessage(t,e){this.messageEl&&(this.messageEl.textContent=e,this.messageEl.dataset.state=t,this.messageEl.hidden=!1)}clearMessage(){this.messageEl&&(this.messageEl.textContent="",this.messageEl.removeAttribute("data-state"),this.messageEl.hidden=!0)}resetFormState(){this.bookings=[],this.requiresApproval=!1,this.clearSelection(),this.clearMessage(),this.form&&(this.form.hidden=!1,this.form.reset()),this.confirmation&&(this.confirmation.hidden=!0),this.durationSelect.value="60"}setSlotGridBusy(t){this.slotGrid&&this.slotGrid.classList.toggle("is-loading",t)}getRequiredSlots(){const t=parseInt(this.durationSelect.value,10)||30;return Math.max(1,Math.ceil(t/30))}getSelectionWindow(){if(!this.selectedRange||!this.dateInput||!this.dateInput.value)return null;const t=Number(this.slotButtons[this.selectedRange.startIndex].dataset.minutes),e=this.selectedRange.slots*30,s=t+e,i=new Date(`${this.dateInput.value}T00:00:00`),r=this.combineDate(i,t),a=this.combineDate(i,s);return{dateISO:this.dateInput.value,dateLabel:r.toLocaleDateString(void 0,{weekday:"long",month:"short",day:"numeric"}),timeLabel:`${this.formatTime(r)} â€“ ${this.formatTime(a)}`,durationLabel:`${e} minutes`,purposeLabel:this.purposeInput.value.trim(),noteLabel:this.requiresApproval?"Requires approval":"Auto-approve",startTime:this.formatTime24(r),endTime:this.formatTime24(a),durationMinutes:e}}combineDate(t,e){const s=new Date(t);return s.setHours(0,e,0,0),s}formatMinutes(t){const e=Math.floor(t/60),s=t%60,i=new Date;return i.setHours(e,s,0,0),this.formatTime(i)}formatTime(t){return t.toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})}formatTime24(t){const e=String(t.getHours()).padStart(2,"0"),s=String(t.getMinutes()).padStart(2,"0");return`${e}:${s}`}formatDateInput(t){return t.toISOString().split("T")[0]}}window.addEventListener("DOMContentLoaded",()=>{new l});
